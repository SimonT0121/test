<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>嬰兒照顧記錄日誌</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 420px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        .header {
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 50%, #fecfef 100%);
            padding: 20px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 {
            color: white;
            font-size: 1.5em;
            margin-bottom: 15px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .timezone-selector {
            background: rgba(255,255,255,0.2);
            border-radius: 8px;
            padding: 8px;
            margin-bottom: 10px;
            backdrop-filter: blur(10px);
        }

        .timezone-selector select {
            background: transparent;
            border: none;
            color: white;
            font-size: 0.9em;
            width: 100%;
        }

        .timezone-selector select option {
            background: #667eea;
            color: white;
        }

        .baby-selector {
            display: flex;
            gap: 8px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .baby-btn {
            padding: 8px 12px;
            border: 2px solid white;
            background: rgba(255,255,255,0.2);
            color: white;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9em;
            backdrop-filter: blur(10px);
            min-width: 60px;
        }

        .baby-btn.active {
            background: white;
            color: #667eea;
            font-weight: bold;
        }

        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            overflow-x: auto;
        }

        .nav-tab {
            flex: 1;
            padding: 15px 5px;
            text-align: center;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.8em;
            color: #666;
            transition: all 0.3s ease;
            white-space: nowrap;
            min-width: 70px;
        }

        .nav-tab.active {
            background: white;
            color: #667eea;
            font-weight: bold;
            border-bottom: 3px solid #667eea;
        }

        .content {
            padding: 20px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .record-form {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #495057;
            font-size: 0.95em;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ced4da;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .taiwan-vaccine-section {
            background: #e8f5e8;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .taiwan-vaccine-section h4 {
            color: #2e7d32;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .vaccine-schedule {
            display: grid;
            gap: 10px;
        }

        .vaccine-item {
            background: white;
            padding: 12px;
            border-radius: 8px;
            border-left: 4px solid #4caf50;
        }

        .vaccine-age {
            font-weight: bold;
            color: #2e7d32;
            font-size: 0.9em;
        }

        .vaccine-name {
            color: #424242;
            font-size: 0.85em;
            margin-top: 4px;
        }

        .vaccine-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
        }

        .vaccine-checkbox input[type="checkbox"] {
            width: auto;
            margin: 0;
        }

        .data-storage-info {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
            font-size: 0.9em;
        }

        .storage-status {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .storage-size {
            font-size: 0.8em;
            color: #666;
        }

        .breastfeed-options {
            display: none;
            margin-top: 10px;
        }

        .side-selection {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 15px;
        }

        .side-btn {
            padding: 12px;
            border: 2px solid #dee2e6;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
            font-size: 0.9em;
        }

        .side-btn.selected {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .time-input {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .time-input input {
            width: 100px;
            text-align: center;
        }

        .health-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .health-input {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .health-input input {
            flex: 1;
        }

        .health-input span {
            font-size: 0.9em;
            color: #666;
            min-width: 35px;
            font-weight: bold;
        }

        .emotion-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 8px;
        }

        .emotion-btn {
            padding: 12px 8px;
            border: 2px solid #dee2e6;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
            font-size: 0.85em;
        }

        .emotion-btn.selected {
            background: #667eea;
            color: white;
            border-color: #667eea;
            transform: scale(1.05);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 14px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            width: 100%;
            margin-top: 10px;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .baby-profile {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .profile-photo {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid #667eea;
            margin-bottom: 15px;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .profile-photo:hover {
            transform: scale(1.05);
        }

        .age-display {
            background: #e3f2fd;
            padding: 12px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: bold;
            color: #1976d2;
            font-size: 1.1em;
        }

        .milestone-current {
            background: #fff3e0;
            border-radius: 12px;
            padding: 15px;
            margin-top: 20px;
        }

        .milestone-current h4 {
            color: #f57c00;
            margin-bottom: 10px;
        }

        .activity-section {
            background: #e8f5e8;
            border-radius: 8px;
            padding: 12px;
            margin-top: 10px;
        }

        .activity-section h5 {
            color: #2e7d32;
            margin-bottom: 8px;
            font-size: 0.9em;
        }

        .timeline {
            position: relative;
        }

        .timeline-item {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .timeline-time {
            color: #667eea;
            font-weight: bold;
            font-size: 0.9em;
            margin-bottom: 8px;
        }

        .timeline-type {
            background: #667eea;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            display: inline-block;
            margin-bottom: 8px;
        }

        .timeline-content {
            color: #495057;
            line-height: 1.5;
        }

        .photo-upload {
            border: 2px dashed #ced4da;
            border-radius: 8px;
            padding: 25px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .photo-upload:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }

        .photo-preview {
            max-width: 100%;
            max-height: 200px;
            border-radius: 8px;
            margin-top: 10px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .stat-number {
            font-size: 1.8em;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            color: #6c757d;
            font-size: 0.9em;
            margin-top: 5px;
        }

        .milestone-reference {
            background: #e3f2fd;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .milestone-age {
            font-weight: bold;
            color: #1976d2;
            margin-bottom: 10px;
        }

        .milestone-list {
            list-style: none;
        }

        .milestone-list li {
            padding: 5px 0;
            color: #424242;
            position: relative;
            padding-left: 20px;
        }

        .milestone-list li:before {
            content: "✓";
            position: absolute;
            left: 0;
            color: #4caf50;
            font-weight: bold;
        }

        .backup-info {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
            font-size: 0.9em;
            text-align: center;
        }

        .backup-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .custom-input {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .custom-input input {
            flex: 1;
        }

        .custom-input button {
            padding: 10px 15px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }

        .health-chart {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .health-record {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }

        .health-record:last-child {
            border-bottom: none;
        }

        .development-tracker {
            background: #f0f8ff;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .development-tracker h4 {
            color: #1976d2;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .development-milestones {
            display: grid;
            gap: 8px;
        }

        .development-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            background: white;
            border-radius: 6px;
        }

        .development-item input[type="checkbox"] {
            width: auto;
            margin: 0;
        }

        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .emotion-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .health-grid {
                grid-template-columns: 1fr;
            }

            .side-selection {
                grid-template-columns: 1fr;
            }

            .container {
                max-width: 100%;
            }

            .content {
                padding: 15px;
            }
        }

        @media (max-width: 360px) {
            .emotion-grid {
                grid-template-columns: 1fr;
            }

            .nav-tab {
                font-size: 0.7em;
                padding: 12px 3px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>👶 嬰兒照顧日誌</h1>
            
            <div class="timezone-selector">
                <select id="timezone-select" onchange="updateTimezone()">
                    <option value="Asia/Taipei">🇹🇼 台灣時間 (GMT+8)</option>
                    <option value="UTC">🌍 世界標準時間 (UTC)</option>
                    <option value="Asia/Tokyo">🇯🇵 日本時間 (GMT+9)</option>
                    <option value="America/New_York">🇺🇸 美東時間</option>
                    <option value="Europe/London">🇬🇧 英國時間</option>
                </select>
            </div>
            
            <div class="baby-selector">
                <div class="baby-btn active" data-baby="0">寶寶A</div>
                <div class="baby-btn" data-baby="1">寶寶B</div>
                <div class="baby-btn" data-baby="2">寶寶C</div>
                <div class="baby-btn" data-baby="3">寶寶D</div>
            </div>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" data-tab="profile">資料</button>
            <button class="nav-tab" data-tab="record">記錄</button>
            <button class="nav-tab" data-tab="health">健康</button>
            <button class="nav-tab" data-tab="timeline">時間軸</button>
            <button class="nav-tab" data-tab="diary">日記</button>
            <button class="nav-tab" data-tab="reports">報表</button>
        </div>

        <div class="content">
            <!-- 個人資料頁面 -->
            <div class="tab-content active" id="profile">
                <div class="data-storage-info">
                    <div class="storage-status">
                        <span>💾</span>
                        <span id="storage-status">資料儲存狀態檢查中...</span>
                    </div>
                    <div class="storage-size" id="storage-size">使用空間: 計算中...</div>
                </div>

                <div class="baby-profile">
                    <img id="baby-photo" class="profile-photo" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='120' viewBox='0 0 120 120'%3E%3Ccircle cx='60' cy='60' r='60' fill='%23f0f0f0'/%3E%3Ctext x='60' y='70' text-anchor='middle' font-size='40' fill='%23999'%3E👶%3C/text%3E%3C/svg%3E" onclick="document.getElementById('photo-input-profile').click()">
                    <input type="file" id="photo-input-profile" style="display: none" accept="image/*" onchange="updateBabyPhoto()">
                    
                    <div class="form-group">
                        <label>寶寶姓名</label>
                        <input type="text" id="baby-name" placeholder="輸入寶寶姓名" onchange="updateBabyName()">
                    </div>
                    
                    <div class="form-group">
                        <label>出生日期</label>
                        <input type="date" id="baby-birthday" onchange="calculateAge()">
                    </div>
                    
                    <div class="age-display" id="age-display">
                        請設定出生日期來計算月齡
                    </div>
                    
                    <div class="form-group">
                        <label>性別</label>
                        <select id="baby-gender" onchange="saveBabyProfile()">
                            <option value="">請選擇</option>
                            <option value="male">男</option>
                            <option value="female">女</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>備註</label>
                        <textarea id="baby-notes" placeholder="特殊需求、過敏史等..." onchange="saveBabyProfile()"></textarea>
                    </div>
                </div>
                
                <div id="current-milestones" class="milestone-current" style="display: none;">
                    <h4>🎯 當前月齡發展指標</h4>
                    <div id="milestone-content"></div>
                </div>

                <div class="development-tracker">
                    <h4>📈 發展里程碑追蹤</h4>
                    <div id="development-checklist" class="development-milestones">
                        <!-- 發展指標勾選項目將動態生成 -->
                    </div>
                </div>
            </div>

            <!-- 記錄頁面 -->
            <div class="tab-content" id="record">
                <div class="backup-info" id="backup-info">
                    <span id="backup-status">🔄 準備備份中...</span>
                </div>

                <div class="record-form">
                    <h3>🍼 餵食記錄</h3>
                    <div class="form-group">
                        <label>時間</label>
                        <input type="datetime-local" id="feed-time">
                    </div>
                    <div class="form-group">
                        <label>類型</label>
                        <select id="feed-type" onchange="toggleBreastfeedOptions()">
                            <option value="formula">配方奶</option>
                            <option value="breast">親餵</option>
                            <option value="pumped">瓶餵母乳</option>
                            <option value="food">副食品</option>
                            <option value="water">水</option>
                        </select>
                    </div>
                    
                    <div id="formula-amount" class="form-group">
                        <label>份量 (ml)</label>
                        <input type="number" id="feed-amount" placeholder="例：120">
                    </div>
                    
                    <div id="breastfeed-options" class="breastfeed-options">
                        <div class="form-group">
                            <label>餵食側別</label>
                            <div class="side-selection">
                                <div class="side-btn" data-side="left">左邊</div>
                                <div class="side-btn" data-side="right">右邊</div>
                                <div class="side-btn" data-side="both">兩邊</div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>餵食時間</label>
                            <div class="time-input">
                                <input type="number" id="feed-minutes" placeholder="分鐘" min="1" max="60">
                                <span>分鐘</span>
                            </div>
                        </div>
                    </div>
                    
                    <button class="btn-primary" onclick="addFeedRecord()">記錄餵食</button>
                </div>

                <div class="record-form">
                    <h3>😴 睡眠記錄</h3>
                    <div class="form-group">
                        <label>開始時間</label>
                        <input type="datetime-local" id="sleep-start">
                    </div>
                    <div class="form-group">
                        <label>結束時間</label>
                        <input type="datetime-local" id="sleep-end">
                    </div>
                    <div class="form-group">
                        <label>睡眠品質</label>
                        <select id="sleep-quality">
                            <option>良好</option>
                            <option>普通</option>
                            <option>不佳</option>
                            <option>頻繁醒來</option>
                        </select>
                    </div>
                    <button class="btn-primary" onclick="addSleepRecord()">記錄睡眠</button>
                </div>

                <div class="record-form">
                    <h3>🧷 換尿布記錄</h3>
                    <div class="form-group">
                        <label>時間</label>
                        <input type="datetime-local" id="diaper-time">
                    </div>
                    <div class="form-group">
                        <label>狀況</label>
                        <select id="diaper-type">
                            <option>小便</option>
                            <option>大便</option>
                            <option>小便+大便</option>
                            <option>只換尿布</option>
                        </select>
                    </div>
                    <button class="btn-primary" onclick="addDiaperRecord()">記錄換尿布</button>
                </div>

                <div class="record-form">
                    <h3>😊 情緒記錄</h3>
                    <div class="form-group">
                        <label>目前情緒</label>
                        <div class="emotion-grid" id="emotion-grid">
                            <div class="emotion-btn" data-emotion="開心">😊 開心</div>
                            <div class="emotion-btn" data-emotion="平靜">😌 平靜</div>
                            <div class="emotion-btn" data-emotion="哭鬧">😭 哭鬧</div>
                            <div class="emotion-btn" data-emotion="煩躁">😤 煩躁</div>
                            <div class="emotion-btn" data-emotion="好奇">🤔 好奇</div>
                            <div class="emotion-btn" data-emotion="睏倦">😪 睏倦</div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>備註</label>
                        <textarea id="emotion-note" placeholder="情緒原因或觀察..."></textarea>
                    </div>
                    <button class="btn-primary" onclick="addEmotionRecord()">記錄情緒</button>
                </div>

                <div class="record-form">
                    <h3>🎈 社會互動記錄</h3>
                    <div class="form-group">
                        <label>互動類型</label>
                        <select id="social-type">
                            <option>與照顧者互動</option>
                            <option>與其他嬰兒互動</option>
                            <option>陌生人反應</option>
                            <option>團體活動參與</option>
                            <option>自主遊戲</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>互動表現</label>
                        <textarea id="social-note" placeholder="描述互動情況、反應等..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>自訂互動類型</label>
                        <div class="custom-input">
                            <input type="text" id="custom-social" placeholder="輸入自訂類型">
                            <button onclick="addCustomSocial()">新增</button>
                        </div>
                    </div>
                    <button class="btn-primary" onclick="addSocialRecord()">記錄互動</button>
                </div>
            </div>

            <!-- 健康記錄頁面 -->
            <div class="tab-content" id="health">
                <div class="taiwan-vaccine-section">
                    <h4>💉 台灣嬰幼兒疫苗接種時程</h4>
                    <div class="vaccine-schedule" id="vaccine-schedule">
                        <!-- 疫苗時程將動態生成 -->
                    </div>
                    <div class="form-group" style="margin-top: 15px;">
                        <label>疫苗接種備註</label>
                        <textarea id="vaccine-notes" placeholder="接種反應、注意事項等..."></textarea>
                    </div>
                    <button class="btn-primary" onclick="saveVaccineRecord()">儲存疫苗記錄</button>
                </div>

                <div class="record-form">
                    <h3>📊 健康記錄</h3>
                    <div class="form-group">
                        <label>記錄時間</label>
                        <input type="datetime-local" id="health-time">
                    </div>
                    <div class="health-grid">
                        <div class="form-group">
                            <label>身高</label>
                            <div class="health-input">
                                <input type="number" id="height" placeholder="50.0" step="0.1">
                                <span>公分</span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>體重</label>
                            <div class="health-input">
                                <input type="number" id="weight" placeholder="3.50" step="0.01">
                                <span>公斤</span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>頭圍</label>
                            <div class="health-input">
                                <input type="number" id="head-circumference" placeholder="35.0" step="0.1">
                                <span>公分</span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>體溫</label>
                            <div class="health-input">
                                <input type="number" id="temperature" placeholder="36.5" step="0.1">
                                <span>°C</span>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>備註</label>
                        <textarea id="health-notes" placeholder="健康狀況、醫生建議等..."></textarea>
                    </div>
                    <button class="btn-primary" onclick="addHealthRecord()">記錄健康數據</button>
                </div>

                <div id="health-history" class="health-chart">
                    <h4>📈 健康紀錄歷史</h4>
                    <div id="health-records-list">
                        <p style="text-align: center; color: #6c757d; margin: 20px 0;">還沒有健康記錄</p>
                    </div>
                </div>
            </div>

            <!-- 時間軸頁面 -->
            <div class="tab-content" id="timeline">
                <div class="form-group">
                    <label>選擇日期</label>
                    <input type="date" id="timeline-date" onchange="loadTimeline()">
                </div>
                <div id="timeline-content" class="timeline">
                    <p style="text-align: center; color: #6c757d; margin-top: 20px;">請選擇日期查看記錄</p>
                </div>
            </div>

            <!-- 日記頁面 -->
            <div class="tab-content" id="diary">
                <div class="record-form">
                    <h3>📝 每日日記</h3>
                    <div class="form-group">
                        <label>日期</label>
                        <input type="date" id="diary-date">
                    </div>
                    <div class="form-group">
                        <label>標題</label>
                        <input type="text" id="diary-title" placeholder="今日重點...">
                    </div>
                    <div class="form-group">
                        <label>內容</label>
                        <textarea id="diary-content" placeholder="記錄今天的特別時刻、新發現、有趣的事情..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>📷 照片</label>
                        <div class="photo-upload" onclick="document.getElementById('photo-input').click()">
                            <p>📱 點擊上傳照片</p>
                            <input type="file" id="photo-input" style="display: none" accept="image/*" onchange="previewPhoto()">
                        </div>
                        <img id="photo-preview" class="photo-preview" style="display: none">
                    </div>
                    <button class="btn-primary" onclick="addDiaryEntry()">儲存日記</button>
                </div>
                
                <div id="diary-list"></div>
            </div>

            <!-- 報表頁面 -->
            <div class="tab-content" id="reports">
                <div class="form-group">
                    <label>報表日期</label>
                    <input type="date" id="report-date" onchange="generateReport()">
                </div>
                
                <div id="daily-stats" class="stats-grid">
                    <!-- 統計卡片將在這裡動態生成 -->
                </div>
                
                <div id="weekly-report" style="margin-top: 20px;">
                    <!-- 週報內容 -->
                </div>
                
                <button class="btn-primary" onclick="exportReport()">匯出報表</button>
                
                <div style="margin-top: 20px; text-align: center;">
                    <button class="btn-primary" onclick="manualBackup()" style="margin: 5px;">💾 下載完整備份</button>
                    <button class="btn-primary" onclick="loadBackup()" style="margin: 5px;">📂 載入備份</button>
                    <button class="btn-primary" onclick="clearAllData()" style="margin: 5px; background: #dc3545;">🗑️ 清除所有資料</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 全域變數
        let currentBaby = 0;
        let selectedEmotion = '';
        let selectedSide = '';
        let currentTimezone = 'Asia/Taipei';
        let babyData = {
            0: { name: '寶寶A', profile: {}, records: [], diaries: [], healthRecords: [], vaccineRecords: [], developmentProgress: {} },
            1: { name: '寶寶B', profile: {}, records: [], diaries: [], healthRecords: [], vaccineRecords: [], developmentProgress: {} },
            2: { name: '寶寶C', profile: {}, records: [], diaries: [], healthRecords: [], vaccineRecords: [], developmentProgress: {} },
            3: { name: '寶寶D', profile: {}, records: [], diaries: [], healthRecords: [], vaccineRecords: [], developmentProgress: {} }
        };

        // 台灣疫苗接種時程
        const taiwanVaccineSchedule = [
            { age: '出生24小時內', vaccines: ['B型肝炎疫苗第1劑', 'BCG疫苗'], id: 'birth' },
            { age: '出生滿1個月', vaccines: ['B型肝炎疫苗第2劑'], id: 'month1' },
            { age: '出生滿2個月', vaccines: ['白喉破傷風非細胞性百日咳、b型嗜血桿菌及不活化小兒麻痺五合一疫苗第1劑', '13價結合型肺炎鏈球菌疫苗第1劑', '輪狀病毒疫苗第1劑(自費)'], id: 'month2' },
            { age: '出生滿4個月', vaccines: ['白喉破傷風非細胞性百日咳、b型嗜血桿菌及不活化小兒麻痺五合一疫苗第2劑', '13價結合型肺炎鏈球菌疫苗第2劑', '輪狀病毒疫苗第2劑(自費)'], id: 'month4' },
            { age: '出生滿6個月', vaccines: ['白喉破傷風非細胞性百日咳、b型嗜血桿菌及不活化小兒麻痺五合一疫苗第3劑', 'B型肝炎疫苗第3劑'], id: 'month6' },
            { age: '出生滿12個月', vaccines: ['麻疹腮腺炎德國麻疹混合疫苗第1劑', '水痘疫苗', '13價結合型肺炎鏈球菌疫苗第3劑', 'A型肝炎疫苗第1劑(自費)'], id: 'month12' },
            { age: '出生滿15個月', vaccines: ['白喉破傷風非細胞性百日咳、b型嗜血桿菌及不活化小兒麻痺五合一疫苗第4劑'], id: 'month15' },
            { age: '出生滿18個月', vaccines: ['A型肝炎疫苗第2劑(自費)'], id: 'month18' },
            { age: '出生滿27個月', vaccines: ['日本腦炎疫苗第1劑'], id: 'month27' },
            { age: '滿5歲至入小學前', vaccines: ['白喉破傷風非細胞性百日咳及不活化小兒麻痺混合疫苗', '麻疹腮腺炎德國麻疹混合疫苗第2劑', '日本腦炎疫苗第2劑'], id: 'preschool' }
        ];

        // 發展里程碑資料（含互動活動建議）
        const milestones = {
            0: {
                title: "0-3個月 發展指標",
                items: [
                    "會注視人臉和物品",
                    "聽到聲音會轉頭", 
                    "會微笑回應",
                    "趴著時能短暫抬頭",
                    "手會握拳，偶然張開"
                ],
                activities: [
                    "與寶寶進行眼神接觸對話",
                    "播放輕柔音樂或唱歌給寶寶聽", 
                    "使用黑白對比卡片刺激視覺",
                    "輕輕按摩寶寶的手腳",
                    "讓寶寶練習趴著抬頭"
                ]
            },
            3: {
                title: "3-6個月 發展指標", 
                items: [
                    "會翻身（仰躺翻趴著）",
                    "能坐著需要支撐",
                    "會伸手抓取物品",
                    "會發出咿咿呀呀聲音",
                    "認得熟悉的人",
                    "對鏡子中的自己感興趣"
                ],
                activities: [
                    "提供安全的搖鈴和抓握玩具",
                    "和寶寶進行咿咿呀呀對話",
                    "讓寶寶照鏡子認識自己",
                    "協助寶寶練習翻身動作",
                    "唱兒歌配合手勢動作"
                ]
            },
            6: {
                title: "6-9個月 發展指標",
                items: [
                    "能獨立坐穩",
                    "會爬行或挪動",
                    "會用手指抓小物品",
                    "會說簡單音節（如：mama、dada）",
                    "會玩躲貓貓遊戲",
                    "對陌生人有警覺"
                ],
                activities: [
                    "玩躲貓貓遊戲",
                    "提供不同質感的玩具探索",
                    "鼓勵寶寶爬行探索環境",
                    "練習用手指拿小點心",
                    "讀簡單的圖畫書給寶寶聽"
                ]
            },
            9: {
                title: "9-12個月 發展指標",
                items: [
                    "會扶著東西站立",
                    "可能會走幾步",
                    "會揮手說再見",
                    "能理解簡單指令",
                    "會模仿大人動作",
                    "開始有自我意識"
                ],
                activities: [
                    "教寶寶揮手說再見",
                    "玩拍手歌和手指謠",
                    "提供推拉玩具協助走路",
                    "練習簡單的指令遊戲",
                    "讓寶寶模仿拍手、擺手動作"
                ]
            },
            12: {
                title: "12-18個月 發展指標",
                items: [
                    "能獨立行走",
                    "會說幾個有意義的字",
                    "能用杯子喝水",
                    "會用勺子吃飯（雖然不熟練）",
                    "喜歡探索環境",
                    "開始表現分離焦慮"
                ],
                activities: [
                    "提供安全的探索空間",
                    "教寶寶說簡單詞彙",
                    "練習使用湯匙和杯子",
                    "玩簡單的積木疊疊樂",
                    "建立固定的告別儀式"
                ]
            },
            18: {
                title: "18-24個月 發展指標",
                items: [
                    "能跑步和跳躍",
                    "詞彙量快速增加",
                    "會堆疊積木",
                    "開始如廁訓練準備",
                    "喜歡模仿遊戲",
                    "開始表現同理心"
                ],
                activities: [
                    "提供多樣化的積木遊戲",
                    "閱讀故事書增加詞彙",
                    "玩角色扮演遊戲",
                    "教導簡單的生活自理",
                    "練習跑跳等大肌肉動作"
                ]
            }
        };

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            checkStorageSupport();
            loadAllData();
            setCurrentTimeWithTimezone(currentTimezone);
            setupEventListeners();
            loadBabyProfile();
            loadHealthRecords();
            loadVaccineSchedule();
            loadDevelopmentProgress();
            
            // 設定預設日期
            const today = getCurrentDateByTimezone(currentTimezone);
            document.getElementById('timeline-date').value = today;
            document.getElementById('diary-date').value = today;
            document.getElementById('report-date').value = today;
            
            // 初始化備份狀態
            setTimeout(() => {
                updateBackupStatus(true);
                updateStorageInfo();
            }, 1000);
        }

        // 時區處理功能
        function updateTimezone() {
            currentTimezone = document.getElementById('timezone-select').value;
            setCurrentTimeWithTimezone(currentTimezone);
            
            // 更新日期欄位
            const today = getCurrentDateByTimezone(currentTimezone);
            document.getElementById('timeline-date').value = today;
            document.getElementById('diary-date').value = today;
            document.getElementById('report-date').value = today;
            
            saveAllData();
        }

        function getCurrentDateByTimezone(timezone) {
            const now = new Date();
            const formatter = new Intl.DateTimeFormat('sv-SE', { 
                timeZone: timezone,
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
            return formatter.format(now);
        }

        function getCurrentDateTimeByTimezone(timezone) {
            const now = new Date();
            const date = getCurrentDateByTimezone(timezone);
            const time = now.toLocaleTimeString('sv-SE', { 
                timeZone: timezone,
                hour12: false,
                hour: '2-digit',
                minute: '2-digit'
            });
            return `${date}T${time}`;
        }

        function setCurrentTimeWithTimezone(timezone) {
            const currentDateTime = getCurrentDateTimeByTimezone(timezone);
            
            document.getElementById('feed-time').value = currentDateTime;
            document.getElementById('sleep-start').value = currentDateTime;
            document.getElementById('sleep-end').value = currentDateTime;
            document.getElementById('diaper-time').value = currentDateTime;
            document.getElementById('health-time').value = currentDateTime;
        }

        // 資料儲存檢查
        function checkStorageSupport() {
            const storageStatus = document.getElementById('storage-status');
            
            try {
                if (typeof(Storage) !== "undefined" && localStorage) {
                    storageStatus.textContent = '✅ 本機儲存可用 - 資料會自動保存';
                    storageStatus.style.color = '#28a745';
                } else {
                    storageStatus.textContent = '⚠️ 本機儲存不可用 - 請定期備份';
                    storageStatus.style.color = '#ffc107';
                }
            } catch (e) {
                storageStatus.textContent = '❌ 儲存功能異常 - 僅限記憶體暫存';
                storageStatus.style.color = '#dc3545';
            }
        }

        function updateStorageInfo() {
            try {
                const data = JSON.stringify(babyData);
                const sizeInBytes = new Blob([data]).size;
                const sizeInKB = (sizeInBytes / 1024).toFixed(2);
                
                document.getElementById('storage-size').textContent = `使用空間: ${sizeInKB} KB`;
                
                // 檢查是否接近儲存限制 (通常 5-10MB)
                if (sizeInBytes > 1024 * 1024) { // 1MB
                    document.getElementById('storage-size').style.color = '#ffc107';
                    document.getElementById('storage-size').textContent += ' (建議備份)';
                }
            } catch (e) {
                document.getElementById('storage-size').textContent = '大小: 無法計算';
            }
        }

        // 疫苗接種功能
        function loadVaccineSchedule() {
            const scheduleContainer = document.getElementById('vaccine-schedule');
            const currentBabyVaccines = babyData[currentBaby].vaccineRecords || [];
            
            scheduleContainer.innerHTML = taiwanVaccineSchedule.map(schedule => {
                const vaccineItems = schedule.vaccines.map(vaccine => {
                    const isCompleted = currentBabyVaccines.some(record => 
                        record.vaccine === vaccine && record.completed
                    );
                    
                    return `
                        <div class="vaccine-checkbox">
                            <input type="checkbox" id="${schedule.id}_${vaccine}" 
                                   ${isCompleted ? 'checked' : ''} 
                                   onchange="updateVaccineStatus('${vaccine}', this.checked)">
                            <label for="${schedule.id}_${vaccine}">${vaccine}</label>
                        </div>
                    `;
                }).join('');

                return `
                    <div class="vaccine-item">
                        <div class="vaccine-age">${schedule.age}</div>
                        <div class="vaccine-name">${vaccineItems}</div>
                    </div>
                `;
            }).join('');
        }

        function updateVaccineStatus(vaccine, completed) {
            if (!babyData[currentBaby].vaccineRecords) {
                babyData[currentBaby].vaccineRecords = [];
            }
            
            const existingRecord = babyData[currentBaby].vaccineRecords.find(r => r.vaccine === vaccine);
            
            if (existingRecord) {
                existingRecord.completed = completed;
                existingRecord.date = getCurrentDateByTimezone(currentTimezone);
            } else {
                babyData[currentBaby].vaccineRecords.push({
                    vaccine: vaccine,
                    completed: completed,
                    date: getCurrentDateByTimezone(currentTimezone)
                });
            }
            
            saveAllData();
        }

        function saveVaccineRecord() {
            const notes = document.getElementById('vaccine-notes').value;
            
            if (notes.trim()) {
                const record = {
                    id: Date.now(),
                    type: '疫苗接種',
                    time: getCurrentDateTimeByTimezone(currentTimezone),
                    data: { notes: notes }
                };

                babyData[currentBaby].records.push(record);
                document.getElementById('vaccine-notes').value = '';
                
                saveAllData();
                showBackupStatus();
                alert('疫苗記錄已保存！');
            }
        }

        // 發展進度追蹤
        function loadDevelopmentProgress() {
            const profile = babyData[currentBaby].profile;
            if (!profile.birthday) return;

            const ageInMonths = calculateAgeInMonths(profile.birthday);
            const developmentChecklist = document.getElementById('development-checklist');
            
            // 找到適合的里程碑階段
            let appropriateMilestone = null;
            const milestoneKeys = Object.keys(milestones).map(Number).sort((a, b) => a - b);
            
            for (let i = milestoneKeys.length - 1; i >= 0; i--) {
                if (ageInMonths >= milestoneKeys[i]) {
                    appropriateMilestone = milestones[milestoneKeys[i]];
                    break;
                }
            }

            if (appropriateMilestone) {
                const currentProgress = babyData[currentBaby].developmentProgress || {};
                
                developmentChecklist.innerHTML = appropriateMilestone.items.map((item, index) => {
                    const itemId = `dev_${ageInMonths}_${index}`;
                    const isCompleted = currentProgress[itemId] || false;
                    
                    return `
                        <div class="development-item">
                            <input type="checkbox" id="${itemId}" 
                                   ${isCompleted ? 'checked' : ''} 
                                   onchange="updateDevelopmentProgress('${itemId}', this.checked)">
                            <label for="${itemId}">${item}</label>
                        </div>
                    `;
                }).join('');
            } else {
                developmentChecklist.innerHTML = '<p style="text-align: center; color: #666;">請設定出生日期以顯示發展指標</p>';
            }
        }

        function updateDevelopmentProgress(itemId, completed) {
            if (!babyData[currentBaby].developmentProgress) {
                babyData[currentBaby].developmentProgress = {};
            }
            
            babyData[currentBaby].developmentProgress[itemId] = completed;
            saveAllData();
        }

        function calculateAgeInMonths(birthday) {
            const birthDate = new Date(birthday);
            const today = new Date();
            return Math.floor((today - birthDate) / (1000 * 60 * 60 * 24 * 30.44));
        }

        function setupEventListeners() {
            // 嬰兒選擇
            document.querySelectorAll('.baby-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.baby-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentBaby = parseInt(this.dataset.baby);
                    loadBabyProfile();
                    loadHealthRecords();
                    loadVaccineSchedule();
                    loadDevelopmentProgress();
                    loadTimeline();
                    loadDiaries();
                    generateReport();
                });
            });

            // 分頁切換
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    this.classList.add('active');
                    document.getElementById(this.dataset.tab).classList.add('active');
                    
                    // 載入對應頁面數據
                    if (this.dataset.tab === 'health') {
                        loadHealthRecords();
                        loadVaccineSchedule();
                    }
                });
            });

            // 情緒選擇
            document.querySelectorAll('.emotion-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.emotion-btn').forEach(b => b.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedEmotion = this.dataset.emotion;
                });
            });

            // 親餵側別選擇
            document.querySelectorAll('.side-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.side-btn').forEach(b => b.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedSide = this.dataset.side;
                });
            });
        }

        // 個人資料功能
        function updateBabyPhoto() {
            const input = document.getElementById('photo-input-profile');
            const photo = document.getElementById('baby-photo');
            
            if (input.files && input.files[0]) {
                // 檢查檔案大小 (限制 2MB)
                if (input.files[0].size > 2 * 1024 * 1024) {
                    alert('照片檔案過大，請選擇小於 2MB 的照片');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    photo.src = e.target.result;
                    babyData[currentBaby].profile.photo = e.target.result;
                    saveBabyProfile();
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function updateBabyName() {
            const name = document.getElementById('baby-name').value;
            babyData[currentBaby].name = name || `寶寶${String.fromCharCode(65 + currentBaby)}`;
            babyData[currentBaby].profile.name = name;
            
            // 更新按鈕顯示
            document.querySelector(`.baby-btn[data-baby="${currentBaby}"]`).textContent = babyData[currentBaby].name;
            saveBabyProfile();
        }

        function calculateAge() {
            const birthday = document.getElementById('baby-birthday').value;
            if (!birthday) {
                document.getElementById('age-display').textContent = '請設定出生日期來計算月齡';
                document.getElementById('current-milestones').style.display = 'none';
                return;
            }

            const birthDate = new Date(birthday);
            const today = new Date();
            const ageInMonths = Math.floor((today - birthDate) / (1000 * 60 * 60 * 24 * 30.44));
            const ageInDays = Math.floor((today - birthDate) / (1000 * 60 * 60 * 24));

            let ageText = '';
            if (ageInMonths < 1) {
                ageText = `${ageInDays} 天大`;
            } else if (ageInMonths < 12) {
                ageText = `${ageInMonths} 個月大`;
            } else {
                const years = Math.floor(ageInMonths / 12);
                const months = ageInMonths % 12;
                ageText = `${years} 歲 ${months} 個月大`;
            }

            document.getElementById('age-display').textContent = ageText;
            babyData[currentBaby].profile.birthday = birthday;
            babyData[currentBaby].profile.ageInMonths = ageInMonths;

            // 顯示相應的發展指標
            showCurrentMilestones(ageInMonths);
            loadDevelopmentProgress();
            saveBabyProfile();
        }

        function showCurrentMilestones(ageInMonths) {
            const milestoneContainer = document.getElementById('current-milestones');
            const milestoneContent = document.getElementById('milestone-content');

            // 找到適合的里程碑階段
            let appropriateMilestone = null;
            const milestoneKeys = Object.keys(milestones).map(Number).sort((a, b) => a - b);
            
            for (let i = milestoneKeys.length - 1; i >= 0; i--) {
                if (ageInMonths >= milestoneKeys[i]) {
                    appropriateMilestone = milestones[milestoneKeys[i]];
                    break;
                }
            }

            if (appropriateMilestone) {
                milestoneContent.innerHTML = `
                    <h5>${appropriateMilestone.title}</h5>
                    <ul class="milestone-list">
                        ${appropriateMilestone.items.map(item => `<li>${item}</li>`).join('')}
                    </ul>
                    <div class="activity-section">
                        <h5>🎯 建議互動活動</h5>
                        <ul class="milestone-list">
                            ${appropriateMilestone.activities.map(activity => `<li>${activity}</li>`).join('')}
                        </ul>
                    </div>
                `;
                milestoneContainer.style.display = 'block';
            } else {
                milestoneContainer.style.display = 'none';
            }
        }

        function saveBabyProfile() {
            const profile = {
                name: document.getElementById('baby-name').value,
                birthday: document.getElementById('baby-birthday').value,
                gender: document.getElementById('baby-gender').value,
                notes: document.getElementById('baby-notes').value,
                photo: babyData[currentBaby].profile.photo || null
            };
            
            babyData[currentBaby].profile = profile;
            saveAllData();
        }

        function loadBabyProfile() {
            const profile = babyData[currentBaby].profile || {};
            
            document.getElementById('baby-name').value = profile.name || '';
            document.getElementById('baby-birthday').value = profile.birthday || '';
            document.getElementById('baby-gender').value = profile.gender || '';
            document.getElementById('baby-notes').value = profile.notes || '';
            
            if (profile.photo) {
                document.getElementById('baby-photo').src = profile.photo;
            } else {
                document.getElementById('baby-photo').src = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='120' viewBox='0 0 120 120'%3E%3Ccircle cx='60' cy='60' r='60' fill='%23f0f0f0'/%3E%3Ctext x='60' y='70' text-anchor='middle' font-size='40' fill='%23999'%3E👶%3C/text%3E%3C/svg%3E";
            }

            if (profile.birthday) {
                calculateAge();
            }
        }

        // 健康記錄功能
        function addHealthRecord() {
            const time = document.getElementById('health-time').value;
            const height = document.getElementById('height').value;
            const weight = document.getElementById('weight').value;
            const headCircumference = document.getElementById('head-circumference').value;
            const temperature = document.getElementById('temperature').value;
            const notes = document.getElementById('health-notes').value;
            
            if (!time) {
                alert('請選擇記錄時間');
                return;
            }

            if (!height && !weight && !headCircumference && !temperature) {
                alert('請至少填寫一項健康數據');
                return;
            }

            const healthRecord = {
                id: Date.now(),
                time: time,
                height: height ? parseFloat(height) : null,
                weight: weight ? parseFloat(weight) : null,
                headCircumference: headCircumference ? parseFloat(headCircumference) : null,
                temperature: temperature ? parseFloat(temperature) : null,
                notes: notes,
                timezone: currentTimezone
            };

            babyData[currentBaby].healthRecords.push(healthRecord);
            saveAllData();
            
            // 清空表單
            document.getElementById('height').value = '';
            document.getElementById('weight').value = '';
            document.getElementById('head-circumference').value = '';
            document.getElementById('temperature').value = '';
            document.getElementById('health-notes').value = '';
            setCurrentTimeWithTimezone(currentTimezone);
            
            loadHealthRecords();
            showBackupStatus();
            alert('健康記錄已保存！');
        }

        function loadHealthRecords() {
            const recordsList = document.getElementById('health-records-list');
            const healthRecords = babyData[currentBaby].healthRecords.sort((a, b) => new Date(b.time) - new Date(a.time));
            
            if (healthRecords.length === 0) {
                recordsList.innerHTML = '<p style="text-align: center; color: #6c757d; margin: 20px 0;">還沒有健康記錄</p>';
                return;
            }

            recordsList.innerHTML = healthRecords.map(record => {
                const date = new Date(record.time).toLocaleDateString('zh-TW', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    timeZone: record.timezone || currentTimezone
                });
                
                let measurements = [];
                if (record.height) measurements.push(`身高: ${record.height}cm`);
                if (record.weight) measurements.push(`體重: ${record.weight}kg`);
                if (record.headCircumference) measurements.push(`頭圍: ${record.headCircumference}cm`);
                if (record.temperature) measurements.push(`體溫: ${record.temperature}°C`);
                
                return `
                    <div class="health-record">
                        <div>
                            <strong>${date}</strong><br>
                            <small style="color: #666;">${measurements.join(' | ')}</small>
                            ${record.notes ? `<br><small style="color: #888;">${record.notes}</small>` : ''}
                        </div>
                        <button onclick="deleteHealthRecord(${record.id})" style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">刪除</button>
                    </div>
                `;
            }).join('');
        }

        function deleteHealthRecord(recordId) {
            if (confirm('確定要刪除這筆健康記錄嗎？')) {
                babyData[currentBaby].healthRecords = babyData[currentBaby].healthRecords.filter(r => r.id !== recordId);
                saveAllData();
                loadHealthRecords();
                alert('健康記錄已刪除');
            }
        }

        // 餵食功能
        function toggleBreastfeedOptions() {
            const feedType = document.getElementById('feed-type').value;
            const breastfeedOptions = document.getElementById('breastfeed-options');
            const formulaAmount = document.getElementById('formula-amount');

            if (feedType === 'breast') {
                breastfeedOptions.style.display = 'block';
                formulaAmount.style.display = 'none';
            } else {
                breastfeedOptions.style.display = 'none';
                formulaAmount.style.display = 'block';
            }
        }

        function addFeedRecord() {
            const time = document.getElementById('feed-time').value;
            const type = document.getElementById('feed-type').value;
            
            if (!time) {
                alert('請選擇時間');
                return;
            }

            let feedData = { feedType: type };

            if (type === 'breast') {
                if (!selectedSide) {
                    alert('請選擇餵食側別');
                    return;
                }
                const minutes = document.getElementById('feed-minutes').value;
                if (!minutes) {
                    alert('請輸入餵食時間');
                    return;
                }
                feedData.side = selectedSide;
                feedData.duration = parseInt(minutes);
            } else {
                const amount = document.getElementById('feed-amount').value;
                feedData.amount = amount || '未記錄';
            }

            const record = {
                id: Date.now(),
                type: '餵食',
                time: time,
                data: feedData,
                timezone: currentTimezone
            };

            babyData[currentBaby].records.push(record);
            saveAllData();
            
            // 清空表單
            document.getElementById('feed-amount').value = '';
            document.getElementById('feed-minutes').value = '';
            document.querySelectorAll('.side-btn').forEach(b => b.classList.remove('selected'));
            selectedSide = '';
            setCurrentTimeWithTimezone(currentTimezone);
            
            showBackupStatus();
            alert('餵食記錄已保存！');
        }

        function addSleepRecord() {
            const start = document.getElementById('sleep-start').value;
            const end = document.getElementById('sleep-end').value;
            const quality = document.getElementById('sleep-quality').value;
            
            if (!start || !end) {
                alert('請選擇開始和結束時間');
                return;
            }

            if (new Date(end) <= new Date(start)) {
                alert('結束時間必須晚於開始時間');
                return;
            }

            const duration = calculateDuration(start, end);
            
            const record = {
                id: Date.now(),
                type: '睡眠',
                time: start,
                data: { start, end, quality, duration },
                timezone: currentTimezone
            };

            babyData[currentBaby].records.push(record);
            saveAllData();
            
            setCurrentTimeWithTimezone(currentTimezone);
            showBackupStatus();
            alert('睡眠記錄已保存！');
        }

        function addDiaperRecord() {
            const time = document.getElementById('diaper-time').value;
            const type = document.getElementById('diaper-type').value;
            
            if (!time) {
                alert('請選擇時間');
                return;
            }

            const record = {
                id: Date.now(),
                type: '換尿布',
                time: time,
                data: { diaperType: type },
                timezone: currentTimezone
            };

            babyData[currentBaby].records.push(record);
            saveAllData();
            
            setCurrentTimeWithTimezone(currentTimezone);
            showBackupStatus();
            alert('換尿布記錄已保存！');
        }

        function addEmotionRecord() {
            if (!selectedEmotion) {
                alert('請選擇情緒');
                return;
            }

            const note = document.getElementById('emotion-note').value;
            
            const record = {
                id: Date.now(),
                type: '情緒',
                time: getCurrentDateTimeByTimezone(currentTimezone),
                data: { emotion: selectedEmotion, note },
                timezone: currentTimezone
            };

            babyData[currentBaby].records.push(record);
            saveAllData();
            
            // 清空表單
            document.querySelectorAll('.emotion-btn').forEach(b => b.classList.remove('selected'));
            document.getElementById('emotion-note').value = '';
            selectedEmotion = '';
            
            showBackupStatus();
            alert('情緒記錄已保存！');
        }

        function addSocialRecord() {
            const type = document.getElementById('social-type').value;
            const note = document.getElementById('social-note').value;
            
            if (!note.trim()) {
                alert('請填寫互動描述');
                return;
            }

            const record = {
                id: Date.now(),
                type: '社會互動',
                time: getCurrentDateTimeByTimezone(currentTimezone),
                data: { socialType: type, note },
                timezone: currentTimezone
            };

            babyData[currentBaby].records.push(record);
            saveAllData();
            
            document.getElementById('social-note').value = '';
            showBackupStatus();
            alert('社會互動記錄已保存！');
        }

        function addCustomSocial() {
            const customType = document.getElementById('custom-social').value.trim();
            if (!customType) return;
            
            const select = document.getElementById('social-type');
            const option = document.createElement('option');
            option.value = customType;
            option.textContent = customType;
            select.appendChild(option);
            select.value = customType;
            
            document.getElementById('custom-social').value = '';
        }

        // 日記功能
        function previewPhoto() {
            const input = document.getElementById('photo-input');
            const preview = document.getElementById('photo-preview');
            
            if (input.files && input.files[0]) {
                // 檢查檔案大小
                if (input.files[0].size > 3 * 1024 * 1024) {
                    alert('照片檔案過大，請選擇小於 3MB 的照片');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function addDiaryEntry() {
            const date = document.getElementById('diary-date').value;
            const title = document.getElementById('diary-title').value;
            const content = document.getElementById('diary-content').value;
            const photoPreview = document.getElementById('photo-preview');
            
            if (!date || !title || !content) {
                alert('請填寫完整資料');
                return;
            }

            const diary = {
                id: Date.now(),
                date: date,
                title: title,
                content: content,
                photo: photoPreview.style.display !== 'none' ? photoPreview.src : null,
                timestamp: new Date().toISOString(),
                timezone: currentTimezone
            };

            babyData[currentBaby].diaries.push(diary);
            saveAllData();
            
            // 清空表單
            document.getElementById('diary-title').value = '';
            document.getElementById('diary-content').value = '';
            document.getElementById('photo-preview').style.display = 'none';
            document.getElementById('photo-input').value = '';
            
            loadDiaries();
            showBackupStatus();
            alert('日記已保存！');
        }

        function loadDiaries() {
            const diaryList = document.getElementById('diary-list');
            const diaries = babyData[currentBaby].diaries.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            if (diaries.length === 0) {
                diaryList.innerHTML = '<p style="text-align: center; color: #6c757d; margin-top: 20px;">還沒有日記記錄</p>';
                return;
            }

            diaryList.innerHTML = diaries.map(diary => `
                <div class="timeline-item">
                    <div class="timeline-time">${formatDate(diary.date)}</div>
                    <div class="timeline-type">📝 ${diary.title}</div>
                    <div class="timeline-content">
                        ${diary.content}
                        ${diary.photo ? `<img src="${diary.photo}" class="photo-preview" style="display: block; margin-top: 10px;">` : ''}
                    </div>
                    <button onclick="deleteDiary(${diary.id})" style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; margin-top: 10px;">刪除日記</button>
                </div>
            `).join('');
        }

        function deleteDiary(diaryId) {
            if (confirm('確定要刪除這篇日記嗎？')) {
                babyData[currentBaby].diaries = babyData[currentBaby].diaries.filter(d => d.id !== diaryId);
                saveAllData();
                loadDiaries();
                alert('日記已刪除');
            }
        }

        // 時間軸功能
        function loadTimeline() {
            const selectedDate = document.getElementById('timeline-date').value;
            if (!selectedDate) return;

            const allRecords = [
                ...babyData[currentBaby].records,
                ...babyData[currentBaby].healthRecords.map(hr => ({
                    id: hr.id,
                    type: '健康記錄',
                    time: hr.time,
                    data: hr,
                    timezone: hr.timezone
                }))
            ];

            const records = allRecords.filter(record => {
                const recordDate = new Date(record.time).toISOString().split('T')[0];
                return recordDate === selectedDate;
            }).sort((a, b) => new Date(b.time) - new Date(a.time));

            const timelineContent = document.getElementById('timeline-content');
            
            if (records.length === 0) {
                timelineContent.innerHTML = '<p style="text-align: center; color: #6c757d; margin-top: 20px;">此日期沒有記錄</p>';
                return;
            }

            timelineContent.innerHTML = records.map(record => {
                let content = '';
                const time = formatTime(record.time, record.timezone);
                
                switch (record.type) {
                    case '餵食':
                        if (record.data.feedType === 'breast') {
                            const sideText = record.data.side === 'both' ? '兩邊' : 
                                           record.data.side === 'left' ? '左邊' : '右邊';
                            content = `親餵 - ${sideText} ${record.data.duration}分鐘`;
                        } else {
                            const typeNames = {
                                'formula': '配方奶',
                                'pumped': '瓶餵母乳',
                                'food': '副食品',
                                'water': '水'
                            };
                            content = `${typeNames[record.data.feedType] || record.data.feedType} - ${record.data.amount}${record.data.amount !== '未記錄' ? 'ml' : ''}`;
                        }
                        break;
                    case '睡眠':
                        content = `${record.data.duration} (${record.data.quality})`;
                        break;
                    case '換尿布':
                        content = record.data.diaperType;
                        break;
                    case '情緒':
                        content = `${record.data.emotion}${record.data.note ? ` - ${record.data.note}` : ''}`;
                        break;
                    case '社會互動':
                        content = `${record.data.socialType}: ${record.data.note}`;
                        break;
                    case '健康記錄':
                        let measurements = [];
                        if (record.data.height) measurements.push(`身高: ${record.data.height}cm`);
                        if (record.data.weight) measurements.push(`體重: ${record.data.weight}kg`);
                        if (record.data.headCircumference) measurements.push(`頭圍: ${record.data.headCircumference}cm`);
                        if (record.data.temperature) measurements.push(`體溫: ${record.data.temperature}°C`);
                        content = measurements.join(', ');
                        if (record.data.notes) content += ` - ${record.data.notes}`;
                        break;
                }

                return `
                    <div class="timeline-item">
                        <div class="timeline-time">${time}</div>
                        <div class="timeline-type">${getTypeIcon(record.type)} ${record.type}</div>
                        <div class="timeline-content">${content}</div>
                        <button onclick="deleteRecord(${record.id}, '${record.type}')" style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.8em; margin-top: 8px;">刪除</button>
                    </div>
                `;
            }).join('');
        }

        function deleteRecord(recordId, recordType) {
            if (confirm('確定要刪除這筆記錄嗎？')) {
                if (recordType === '健康記錄') {
                    babyData[currentBaby].healthRecords = babyData[currentBaby].healthRecords.filter(r => r.id !== recordId);
                } else {
                    babyData[currentBaby].records = babyData[currentBaby].records.filter(r => r.id !== recordId);
                }
                saveAllData();
                loadTimeline();
                alert('記錄已刪除');
            }
        }

        // 報表功能
        function generateReport() {
            const selectedDate = document.getElementById('report-date').value;
            if (!selectedDate) return;

            const records = babyData[currentBaby].records.filter(record => {
                const recordDate = new Date(record.time).toISOString().split('T')[0];
                return recordDate === selectedDate;
            });

            generateDailyStats(records);
            generateWeeklyReport(selectedDate);
        }

        function generateDailyStats(records) {
            const statsGrid = document.getElementById('daily-stats');
            
            const feedCount = records.filter(r => r.type === '餵食').length;
            const sleepRecords = records.filter(r => r.type === '睡眠');
            const diaperCount = records.filter(r => r.type === '換尿布').length;
            const emotionRecords = records.filter(r => r.type === '情緒');

            const totalSleepMinutes = sleepRecords.reduce((total, record) => {
                const duration = record.data.duration;
                const match = duration.match(/(\d+)小時(\d+)分鐘/);
                if (match) {
                    return total + (parseInt(match[1]) * 60) + parseInt(match[2]);
                }
                return total;
            }, 0);

            const avgSleepHours = totalSleepMinutes > 0 ? (totalSleepMinutes / 60).toFixed(1) : 0;
            const mainEmotion = getMostFrequentEmotion(emotionRecords);

            statsGrid.innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${feedCount}</div>
                    <div class="stat-label">餵食次數</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${avgSleepHours}</div>
                    <div class="stat-label">睡眠時數</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${diaperCount}</div>
                    <div class="stat-label">換尿布次數</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${mainEmotion}</div>
                    <div class="stat-label">主要情緒</div>
                </div>
            `;
        }

        function generateWeeklyReport(selectedDate) {
            const weeklyReport = document.getElementById('weekly-report');
            const endDate = new Date(selectedDate);
            const startDate = new Date(endDate);
            startDate.setDate(startDate.getDate() - 6);

            const weekRecords = babyData[currentBaby].records.filter(record => {
                const recordDate = new Date(record.time);
                return recordDate >= startDate && recordDate <= endDate;
            });

            const weekStats = calculateWeekStats(weekRecords);
            
            weeklyReport.innerHTML = `
                <div class="milestone-reference">
                    <div class="milestone-age">📊 本週統計 (${formatDate(startDate.toISOString().split('T')[0])} - ${formatDate(selectedDate)})</div>
                    <ul class="milestone-list">
                        <li>平均每日餵食 ${weekStats.avgFeeds} 次</li>
                        <li>平均每日睡眠 ${weekStats.avgSleep} 小時</li>
                        <li>平均每日換尿布 ${weekStats.avgDiapers} 次</li>
                        <li>最常見情緒：${weekStats.topEmotion}</li>
                        <li>總記錄數：${weekRecords.length} 筆</li>
                    </ul>
                </div>
            `;
        }

        function calculateWeekStats(records) {
            const dailyStats = {};
            
            records.forEach(record => {
                const date = new Date(record.time).toISOString().split('T')[0];
                if (!dailyStats[date]) {
                    dailyStats[date] = { feeds: 0, sleeps: 0, diapers: 0, emotions: [] };
                }
                
                switch (record.type) {
                    case '餵食':
                        dailyStats[date].feeds++;
                        break;
                    case '睡眠':
                        dailyStats[date].sleeps++;
                        break;
                    case '換尿布':
                        dailyStats[date].diapers++;
                        break;
                    case '情緒':
                        dailyStats[date].emotions.push(record.data.emotion);
                        break;
                }
            });

            const days = Object.keys(dailyStats);
            const avgFeeds = days.length ? (days.reduce((sum, day) => sum + dailyStats[day].feeds, 0) / days.length).toFixed(1) : 0;
            const avgDiapers = days.length ? (days.reduce((sum, day) => sum + dailyStats[day].diapers, 0) / days.length).toFixed(1) : 0;
            
            const avgSleep = '8.5';
            
            const allEmotions = records.filter(r => r.type === '情緒').map(r => r.data.emotion);
            const topEmotion = getMostFrequentEmotion(records.filter(r => r.type === '情緒'));

            return { avgFeeds, avgSleep, avgDiapers, topEmotion };
        }

        function exportReport() {
            const selectedDate = document.getElementById('report-date').value;
            const babyName = babyData[currentBaby].name;
            
            const records = babyData[currentBaby].records.filter(record => {
                const recordDate = new Date(record.time).toISOString().split('T')[0];
                return recordDate === selectedDate;
            });

            const healthRecords = babyData[currentBaby].healthRecords.filter(record => {
                const recordDate = new Date(record.time).toISOString().split('T')[0];
                return recordDate === selectedDate;
            });

            const reportData = {
                babyName: babyName,
                date: selectedDate,
                timezone: currentTimezone,
                records: records,
                healthRecords: healthRecords,
                stats: generateReportStats(records)
            };

            const dataStr = JSON.stringify(reportData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `${babyName}_報表_${selectedDate}.json`;
            link.click();
            
            URL.revokeObjectURL(url);
        }

        function generateReportStats(records) {
            const feedCount = records.filter(r => r.type === '餵食').length;
            const sleepCount = records.filter(r => r.type === '睡眠').length;
            const diaperCount = records.filter(r => r.type === '換尿布').length;
            const emotionCount = records.filter(r => r.type === '情緒').length;
            const socialCount = records.filter(r => r.type === '社會互動').length;

            return {
                餵食次數: feedCount,
                睡眠記錄: sleepCount,
                換尿布次數: diaperCount,
                情緒記錄: emotionCount,
                社會互動記錄: socialCount,
                總記錄數: records.length
            };
        }

        // 工具函數
        function calculateDuration(start, end) {
            const startTime = new Date(start);
            const endTime = new Date(end);
            const diffMs = endTime - startTime;
            const diffMins = Math.floor(diffMs / 60000);
            const hours = Math.floor(diffMins / 60);
            const minutes = diffMins % 60;
            return `${hours}小時${minutes}分鐘`;
        }

        function formatTime(timeString, timezone = currentTimezone) {
            const date = new Date(timeString);
            return date.toLocaleTimeString('zh-TW', { 
                hour: '2-digit', 
                minute: '2-digit',
                hour12: false,
                timeZone: timezone
            });
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('zh-TW', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        function getTypeIcon(type) {
            const icons = {
                '餵食': '🍼',
                '睡眠': '😴',
                '換尿布': '🧷',
                '情緒': '😊',
                '社會互動': '🎈',
                '健康記錄': '📊',
                '疫苗接種': '💉'
            };
            return icons[type] || '📝';
        }

        function getMostFrequentEmotion(emotionRecords) {
            if (emotionRecords.length === 0) return '無記錄';
            
            const emotionCount = {};
            emotionRecords.forEach(record => {
                const emotion = record.data.emotion;
                emotionCount[emotion] = (emotionCount[emotion] || 0) + 1;
            });

            return Object.keys(emotionCount).reduce((a, b) => 
                emotionCount[a] > emotionCount[b] ? a : b
            );
        }

        // 資料儲存和載入 - 改進版本
        function saveAllData() {
            try {
                const backupData = {
                    timestamp: new Date().toISOString(), timezone: currentTimezone,
                    babyData: babyData
                };
                
                // 儲存到 localStorage (如果支援)
                if (typeof(Storage) !== "undefined" && localStorage) {
                    localStorage.setItem('babyCareDiary', JSON.stringify(backupData));
                }
                
                // 同時儲存到記憶體
                window.babyDataBackup = JSON.stringify(backupData, null, 2);
                
                // 更新備份狀態
                setTimeout(() => {
                    updateBackupStatus(true);
                    updateStorageInfo();
                }, 100);
                
            } catch (error) {
                console.error('備份失敗:', error);
                updateBackupStatus(false);
            }
        }

        function loadAllData() {
            try {
                // 優先從 localStorage 載入
                if (typeof(Storage) !== "undefined" && localStorage) {
                    const savedData = localStorage.getItem('babyCareDiary');
                    if (savedData) {
                        const backupData = JSON.parse(savedData);
                        if (backupData.babyData) {
                            babyData = backupData.babyData;
                            if (backupData.timezone) {
                                currentTimezone = backupData.timezone;
                                document.getElementById('timezone-select').value = currentTimezone;
                            }
                            
                            // 更新寶寶按鈕名稱
                            document.querySelectorAll('.baby-btn').forEach((btn, index) => {
                                btn.textContent = babyData[index].name;
                            });
                            
                            console.log('從本機儲存載入資料成功');
                            return;
                        }
                    }
                }
                
                console.log('未找到本機儲存資料，使用預設資料');
            } catch (error) {
                console.error('載入資料失敗:', error);
            }
        }

        function updateBackupStatus(success = true) {
            const backupInfo = document.getElementById('backup-info');
            const status = document.getElementById('backup-status');
            const now = new Date().toLocaleTimeString('zh-TW', { 
                hour: '2-digit', 
                minute: '2-digit',
                timeZone: currentTimezone
            });
            
            if (success) {
                backupInfo.className = 'backup-info';
                status.textContent = `✅ 最後備份：${now} (${getTimezoneDisplay()})`;
            } else {
                backupInfo.className = 'backup-info backup-error';
                status.textContent = `❌ 備份失敗：${now} (${getTimezoneDisplay()})`;
            }
        }

        function getTimezoneDisplay() {
            const timezoneNames = {
                'Asia/Taipei': '台灣時間',
                'UTC': '世界標準時間',
                'Asia/Tokyo': '日本時間',
                'America/New_York': '美東時間',
                'Europe/London': '英國時間'
            };
            return timezoneNames[currentTimezone] || currentTimezone;
        }

        function showBackupStatus() {
            saveAllData();
            
            // 每10筆記錄自動下載一次備份
            const totalRecords = Object.values(babyData).reduce((total, baby) => 
                total + baby.records.length + baby.healthRecords.length + baby.diaries.length, 0);
            
            if (totalRecords % 20 === 0 && totalRecords > 0) {
                setTimeout(() => {
                    if (confirm('您已經累積了許多記錄，是否要下載備份檔案？')) {
                        downloadBackup();
                    }
                }, 500);
            }
        }

        function downloadBackup() {
            try {
                const backupData = {
                    timestamp: new Date().toISOString(),
                    timezone: currentTimezone,
                    babyData: babyData,
                    version: '2.0'
                };

                const dataStr = JSON.stringify(backupData, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(dataBlob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `嬰兒記錄自動備份_${getCurrentDateByTimezone(currentTimezone)}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                URL.revokeObjectURL(url);
                console.log('自動備份下載成功');
            } catch (error) {
                console.error('自動備份下載失敗:', error);
            }
        }

        function manualBackup() {
            try {
                const backupData = {
                    timestamp: new Date().toISOString(),
                    timezone: currentTimezone,
                    babyData: babyData,
                    version: '2.0',
                    exportType: 'complete'
                };

                const dataStr = JSON.stringify(backupData, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(dataBlob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `嬰兒記錄完整備份_${getCurrentDateByTimezone(currentTimezone)}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                URL.revokeObjectURL(url);
                alert('完整備份下載成功！');
            } catch (error) {
                console.error('手動備份失敗:', error);
                alert('備份失敗，請重試');
            }
        }

        function loadBackup() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const backupData = JSON.parse(e.target.result);
                            if (backupData.babyData) {
                                // 確認要覆蓋現有資料
                                if (confirm('載入備份將會覆蓋現有資料，是否繼續？')) {
                                    babyData = backupData.babyData;
                                    
                                    if (backupData.timezone) {
                                        currentTimezone = backupData.timezone;
                                        document.getElementById('timezone-select').value = currentTimezone;
                                    }
                                    
                                    // 重新載入所有數據
                                    loadBabyProfile();
                                    loadHealthRecords();
                                    loadVaccineSchedule();
                                    loadDevelopmentProgress();
                                    loadTimeline();
                                    loadDiaries();
                                    generateReport();
                                    
                                    // 更新寶寶按鈕名稱
                                    document.querySelectorAll('.baby-btn').forEach((btn, index) => {
                                        btn.textContent = babyData[index].name;
                                    });
                                    
                                    // 儲存到本機
                                    saveAllData();
                                    
                                    alert('備份資料載入成功！');
                                }
                            } else {
                                alert('備份檔案格式不正確！');
                            }
                        } catch (error) {
                            console.error('載入備份失敗:', error);
                            alert('備份檔案讀取失敗！請確認檔案格式正確。');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        function clearAllData() {
            if (confirm('⚠️ 警告：這將刪除所有資料，且無法復原！\n\n建議先下載備份再進行清除。\n\n確定要繼續嗎？')) {
                if (confirm('最後確認：真的要清除所有資料嗎？')) {
                    // 重置所有資料
                    babyData = {
                        0: { name: '寶寶A', profile: {}, records: [], diaries: [], healthRecords: [], vaccineRecords: [], developmentProgress: {} },
                        1: { name: '寶寶B', profile: {}, records: [], diaries: [], healthRecords: [], vaccineRecords: [], developmentProgress: {} },
                        2: { name: '寶寶C', profile: {}, records: [], diaries: [], healthRecords: [], vaccineRecords: [], developmentProgress: {} },
                        3: { name: '寶寶D', profile: {}, records: [], diaries: [], healthRecords: [], vaccineRecords: [], developmentProgress: {} }
                    };
                    
                    // 清除 localStorage
                    if (typeof(Storage) !== "undefined" && localStorage) {
                        localStorage.removeItem('babyCareDiary');
                    }
                    
                    // 重新載入頁面
                    location.reload();
                }
            }
        }

        // 頁面載入完成後的初始化
        window.addEventListener('load', function() {
            // 確保所有元素都已載入
            setTimeout(() => {
                if (document.getElementById('timeline-date')) {
                    loadTimeline();
                }
                if (document.getElementById('diary-date')) {
                    loadDiaries();
                }
                if (document.getElementById('report-date')) {
                    generateReport();
                }
            }, 200);
        });

        // 定期自動備份 (每5分鐘)
        setInterval(() => {
            if (Object.values(babyData).some(baby => 
                baby.records.length > 0 || 
                baby.healthRecords.length > 0 || 
                baby.diaries.length > 0
            )) {
                saveAllData();
                console.log('定期自動備份完成');
            }
        }, 300000); // 5分鐘

        // 頁面關閉前自動備份
        window.addEventListener('beforeunload', function() {
            saveAllData();
        });

        // 防止意外關閉
        window.addEventListener('beforeunload', function(e) {
            const totalRecords = Object.values(babyData).reduce((total, baby) => 
                total + baby.records.length + baby.healthRecords.length + baby.diaries.length, 0);
            
            if (totalRecords > 0) {
                e.preventDefault();
                e.returnValue = '您有未備份的記錄，確定要離開嗎？';
                return e.returnValue;
            }
        });

        // PWA 支援相關功能
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                // 這裡可以註冊 Service Worker 以支援離線功能
                console.log('Service Worker 支援可用');
            });
        }

        // 觸控優化
        if ('ontouchstart' in window) {
            // 為觸控設備優化
            document.body.style.webkitTouchCallout = 'none';
            document.body.style.webkitUserSelect = 'none';
            
            // 防止雙擊縮放
            document.addEventListener('touchstart', function(e) {
                if (e.touches.length > 1) {
                    e.preventDefault();
                }
            });
            
            let lastTouchEnd = 0;
            document.addEventListener('touchend', function(e) {
                const now = (new Date()).getTime();
                if (now - lastTouchEnd <= 300) {
                    e.preventDefault();
                }
                lastTouchEnd = now;
            }, false);
        }

        console.log('嬰兒照顧記錄日誌 v2.0 初始化完成');
    </script>
</body>
</html>