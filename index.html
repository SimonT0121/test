<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¬°å…’ç…§é¡§è¨˜éŒ„æ—¥èªŒ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 420px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        .header {
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 50%, #fecfef 100%);
            padding: 20px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 {
            color: white;
            font-size: 1.5em;
            margin-bottom: 15px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .timezone-selector {
            background: rgba(255,255,255,0.2);
            border-radius: 8px;
            padding: 8px;
            margin-bottom: 10px;
            backdrop-filter: blur(10px);
        }

        .timezone-selector select {
            background: transparent;
            border: none;
            color: white;
            font-size: 0.9em;
            width: 100%;
        }

        .timezone-selector select option {
            background: #667eea;
            color: white;
        }

        .baby-selector {
            display: flex;
            gap: 8px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .baby-btn {
            padding: 8px 12px;
            border: 2px solid white;
            background: rgba(255,255,255,0.2);
            color: white;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9em;
            backdrop-filter: blur(10px);
            min-width: 60px;
        }

        .baby-btn.active {
            background: white;
            color: #667eea;
            font-weight: bold;
        }

        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            overflow-x: auto;
        }

        .nav-tab {
            flex: 1;
            padding: 15px 5px;
            text-align: center;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.8em;
            color: #666;
            transition: all 0.3s ease;
            white-space: nowrap;
            min-width: 70px;
        }

        .nav-tab.active {
            background: white;
            color: #667eea;
            font-weight: bold;
            border-bottom: 3px solid #667eea;
        }

        .content {
            padding: 20px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .record-form {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #495057;
            font-size: 0.95em;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ced4da;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .taiwan-vaccine-section {
            background: #e8f5e8;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .taiwan-vaccine-section h4 {
            color: #2e7d32;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .vaccine-schedule {
            display: grid;
            gap: 10px;
        }

        .vaccine-item {
            background: white;
            padding: 12px;
            border-radius: 8px;
            border-left: 4px solid #4caf50;
        }

        .vaccine-age {
            font-weight: bold;
            color: #2e7d32;
            font-size: 0.9em;
        }

        .vaccine-name {
            color: #424242;
            font-size: 0.85em;
            margin-top: 4px;
        }

        .vaccine-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
        }

        .vaccine-checkbox input[type="checkbox"] {
            width: auto;
            margin: 0;
        }

        .data-storage-info {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
            font-size: 0.9em;
        }

        .storage-status {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .storage-size {
            font-size: 0.8em;
            color: #666;
        }

        .breastfeed-options {
            display: none;
            margin-top: 10px;
        }

        .side-selection {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 15px;
        }

        .side-btn {
            padding: 12px;
            border: 2px solid #dee2e6;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
            font-size: 0.9em;
        }

        .side-btn.selected {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .time-input {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .time-input input {
            width: 100px;
            text-align: center;
        }

        .health-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .health-input {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .health-input input {
            flex: 1;
        }

        .health-input span {
            font-size: 0.9em;
            color: #666;
            min-width: 35px;
            font-weight: bold;
        }

        .emotion-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 8px;
        }

        .emotion-btn {
            padding: 12px 8px;
            border: 2px solid #dee2e6;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
            font-size: 0.85em;
        }

        .emotion-btn.selected {
            background: #667eea;
            color: white;
            border-color: #667eea;
            transform: scale(1.05);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 14px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            width: 100%;
            margin-top: 10px;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .baby-profile {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .profile-photo {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid #667eea;
            margin-bottom: 15px;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .profile-photo:hover {
            transform: scale(1.05);
        }

        .age-display {
            background: #e3f2fd;
            padding: 12px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: bold;
            color: #1976d2;
            font-size: 1.1em;
        }

        .milestone-current {
            background: #fff3e0;
            border-radius: 12px;
            padding: 15px;
            margin-top: 20px;
        }

        .milestone-current h4 {
            color: #f57c00;
            margin-bottom: 10px;
        }

        .activity-section {
            background: #e8f5e8;
            border-radius: 8px;
            padding: 12px;
            margin-top: 10px;
        }

        .activity-section h5 {
            color: #2e7d32;
            margin-bottom: 8px;
            font-size: 0.9em;
        }

        .timeline {
            position: relative;
        }

        .timeline-item {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .timeline-time {
            color: #667eea;
            font-weight: bold;
            font-size: 0.9em;
            margin-bottom: 8px;
        }

        .timeline-type {
            background: #667eea;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            display: inline-block;
            margin-bottom: 8px;
        }

        .timeline-content {
            color: #495057;
            line-height: 1.5;
        }

        .photo-upload {
            border: 2px dashed #ced4da;
            border-radius: 8px;
            padding: 25px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .photo-upload:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }

        .photo-preview {
            max-width: 100%;
            max-height: 200px;
            border-radius: 8px;
            margin-top: 10px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .stat-number {
            font-size: 1.8em;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            color: #6c757d;
            font-size: 0.9em;
            margin-top: 5px;
        }

        .milestone-reference {
            background: #e3f2fd;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .milestone-age {
            font-weight: bold;
            color: #1976d2;
            margin-bottom: 10px;
        }

        .milestone-list {
            list-style: none;
        }

        .milestone-list li {
            padding: 5px 0;
            color: #424242;
            position: relative;
            padding-left: 20px;
        }

        .milestone-list li:before {
            content: "âœ“";
            position: absolute;
            left: 0;
            color: #4caf50;
            font-weight: bold;
        }

        .backup-info {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
            font-size: 0.9em;
            text-align: center;
        }

        .backup-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .custom-input {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .custom-input input {
            flex: 1;
        }

        .custom-input button {
            padding: 10px 15px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }

        .health-chart {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .health-record {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }

        .health-record:last-child {
            border-bottom: none;
        }

        .development-tracker {
            background: #f0f8ff;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .development-tracker h4 {
            color: #1976d2;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .development-milestones {
            display: grid;
            gap: 8px;
        }

        .development-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            background: white;
            border-radius: 6px;
        }

        .development-item input[type="checkbox"] {
            width: auto;
            margin: 0;
        }

        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .emotion-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .health-grid {
                grid-template-columns: 1fr;
            }

            .side-selection {
                grid-template-columns: 1fr;
            }

            .container {
                max-width: 100%;
            }

            .content {
                padding: 15px;
            }
        }

        @media (max-width: 360px) {
            .emotion-grid {
                grid-template-columns: 1fr;
            }

            .nav-tab {
                font-size: 0.7em;
                padding: 12px 3px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ‘¶ å¬°å…’ç…§é¡§æ—¥èªŒ</h1>
            
            <div class="timezone-selector">
                <select id="timezone-select" onchange="updateTimezone()">
                    <option value="Asia/Taipei">ğŸ‡¹ğŸ‡¼ å°ç£æ™‚é–“ (GMT+8)</option>
                    <option value="UTC">ğŸŒ ä¸–ç•Œæ¨™æº–æ™‚é–“ (UTC)</option>
                    <option value="Asia/Tokyo">ğŸ‡¯ğŸ‡µ æ—¥æœ¬æ™‚é–“ (GMT+9)</option>
                    <option value="America/New_York">ğŸ‡ºğŸ‡¸ ç¾æ±æ™‚é–“</option>
                    <option value="Europe/London">ğŸ‡¬ğŸ‡§ è‹±åœ‹æ™‚é–“</option>
                </select>
            </div>
            
            <div class="baby-selector">
                <div class="baby-btn active" data-baby="0">å¯¶å¯¶A</div>
                <div class="baby-btn" data-baby="1">å¯¶å¯¶B</div>
                <div class="baby-btn" data-baby="2">å¯¶å¯¶C</div>
                <div class="baby-btn" data-baby="3">å¯¶å¯¶D</div>
            </div>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" data-tab="profile">è³‡æ–™</button>
            <button class="nav-tab" data-tab="record">è¨˜éŒ„</button>
            <button class="nav-tab" data-tab="health">å¥åº·</button>
            <button class="nav-tab" data-tab="timeline">æ™‚é–“è»¸</button>
            <button class="nav-tab" data-tab="diary">æ—¥è¨˜</button>
            <button class="nav-tab" data-tab="reports">å ±è¡¨</button>
        </div>

        <div class="content">
            <!-- å€‹äººè³‡æ–™é é¢ -->
            <div class="tab-content active" id="profile">
                <div class="data-storage-info">
                    <div class="storage-status">
                        <span>ğŸ’¾</span>
                        <span id="storage-status">è³‡æ–™å„²å­˜ç‹€æ…‹æª¢æŸ¥ä¸­...</span>
                    </div>
                    <div class="storage-size" id="storage-size">ä½¿ç”¨ç©ºé–“: è¨ˆç®—ä¸­...</div>
                </div>

                <div class="baby-profile">
                    <img id="baby-photo" class="profile-photo" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='120' viewBox='0 0 120 120'%3E%3Ccircle cx='60' cy='60' r='60' fill='%23f0f0f0'/%3E%3Ctext x='60' y='70' text-anchor='middle' font-size='40' fill='%23999'%3EğŸ‘¶%3C/text%3E%3C/svg%3E" onclick="document.getElementById('photo-input-profile').click()">
                    <input type="file" id="photo-input-profile" style="display: none" accept="image/*" onchange="updateBabyPhoto()">
                    
                    <div class="form-group">
                        <label>å¯¶å¯¶å§“å</label>
                        <input type="text" id="baby-name" placeholder="è¼¸å…¥å¯¶å¯¶å§“å" onchange="updateBabyName()">
                    </div>
                    
                    <div class="form-group">
                        <label>å‡ºç”Ÿæ—¥æœŸ</label>
                        <input type="date" id="baby-birthday" onchange="calculateAge()">
                    </div>
                    
                    <div class="age-display" id="age-display">
                        è«‹è¨­å®šå‡ºç”Ÿæ—¥æœŸä¾†è¨ˆç®—æœˆé½¡
                    </div>
                    
                    <div class="form-group">
                        <label>æ€§åˆ¥</label>
                        <select id="baby-gender" onchange="saveBabyProfile()">
                            <option value="">è«‹é¸æ“‡</option>
                            <option value="male">ç”·</option>
                            <option value="female">å¥³</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>å‚™è¨»</label>
                        <textarea id="baby-notes" placeholder="ç‰¹æ®Šéœ€æ±‚ã€éæ•å²ç­‰..." onchange="saveBabyProfile()"></textarea>
                    </div>
                </div>
                
                <div id="current-milestones" class="milestone-current" style="display: none;">
                    <h4>ğŸ¯ ç•¶å‰æœˆé½¡ç™¼å±•æŒ‡æ¨™</h4>
                    <div id="milestone-content"></div>
                </div>

                <div class="development-tracker">
                    <h4>ğŸ“ˆ ç™¼å±•é‡Œç¨‹ç¢‘è¿½è¹¤</h4>
                    <div id="development-checklist" class="development-milestones">
                        <!-- ç™¼å±•æŒ‡æ¨™å‹¾é¸é …ç›®å°‡å‹•æ…‹ç”Ÿæˆ -->
                    </div>
                </div>
            </div>

            <!-- è¨˜éŒ„é é¢ -->
            <div class="tab-content" id="record">
                <div class="backup-info" id="backup-info">
                    <span id="backup-status">ğŸ”„ æº–å‚™å‚™ä»½ä¸­...</span>
                </div>

                <div class="record-form">
                    <h3>ğŸ¼ é¤µé£Ÿè¨˜éŒ„</h3>
                    <div class="form-group">
                        <label>æ™‚é–“</label>
                        <input type="datetime-local" id="feed-time">
                    </div>
                    <div class="form-group">
                        <label>é¡å‹</label>
                        <select id="feed-type" onchange="toggleBreastfeedOptions()">
                            <option value="formula">é…æ–¹å¥¶</option>
                            <option value="breast">è¦ªé¤µ</option>
                            <option value="pumped">ç“¶é¤µæ¯ä¹³</option>
                            <option value="food">å‰¯é£Ÿå“</option>
                            <option value="water">æ°´</option>
                        </select>
                    </div>
                    
                    <div id="formula-amount" class="form-group">
                        <label>ä»½é‡ (ml)</label>
                        <input type="number" id="feed-amount" placeholder="ä¾‹ï¼š120">
                    </div>
                    
                    <div id="breastfeed-options" class="breastfeed-options">
                        <div class="form-group">
                            <label>é¤µé£Ÿå´åˆ¥</label>
                            <div class="side-selection">
                                <div class="side-btn" data-side="left">å·¦é‚Š</div>
                                <div class="side-btn" data-side="right">å³é‚Š</div>
                                <div class="side-btn" data-side="both">å…©é‚Š</div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>é¤µé£Ÿæ™‚é–“</label>
                            <div class="time-input">
                                <input type="number" id="feed-minutes" placeholder="åˆ†é˜" min="1" max="60">
                                <span>åˆ†é˜</span>
                            </div>
                        </div>
                    </div>
                    
                    <button class="btn-primary" onclick="addFeedRecord()">è¨˜éŒ„é¤µé£Ÿ</button>
                </div>

                <div class="record-form">
                    <h3>ğŸ˜´ ç¡çœ è¨˜éŒ„</h3>
                    <div class="form-group">
                        <label>é–‹å§‹æ™‚é–“</label>
                        <input type="datetime-local" id="sleep-start">
                    </div>
                    <div class="form-group">
                        <label>çµæŸæ™‚é–“</label>
                        <input type="datetime-local" id="sleep-end">
                    </div>
                    <div class="form-group">
                        <label>ç¡çœ å“è³ª</label>
                        <select id="sleep-quality">
                            <option>è‰¯å¥½</option>
                            <option>æ™®é€š</option>
                            <option>ä¸ä½³</option>
                            <option>é »ç¹é†’ä¾†</option>
                        </select>
                    </div>
                    <button class="btn-primary" onclick="addSleepRecord()">è¨˜éŒ„ç¡çœ </button>
                </div>

                <div class="record-form">
                    <h3>ğŸ§· æ›å°¿å¸ƒè¨˜éŒ„</h3>
                    <div class="form-group">
                        <label>æ™‚é–“</label>
                        <input type="datetime-local" id="diaper-time">
                    </div>
                    <div class="form-group">
                        <label>ç‹€æ³</label>
                        <select id="diaper-type">
                            <option>å°ä¾¿</option>
                            <option>å¤§ä¾¿</option>
                            <option>å°ä¾¿+å¤§ä¾¿</option>
                            <option>åªæ›å°¿å¸ƒ</option>
                        </select>
                    </div>
                    <button class="btn-primary" onclick="addDiaperRecord()">è¨˜éŒ„æ›å°¿å¸ƒ</button>
                </div>

                <div class="record-form">
                    <h3>ğŸ˜Š æƒ…ç·’è¨˜éŒ„</h3>
                    <div class="form-group">
                        <label>ç›®å‰æƒ…ç·’</label>
                        <div class="emotion-grid" id="emotion-grid">
                            <div class="emotion-btn" data-emotion="é–‹å¿ƒ">ğŸ˜Š é–‹å¿ƒ</div>
                            <div class="emotion-btn" data-emotion="å¹³éœ">ğŸ˜Œ å¹³éœ</div>
                            <div class="emotion-btn" data-emotion="å“­é¬§">ğŸ˜­ å“­é¬§</div>
                            <div class="emotion-btn" data-emotion="ç…©èº">ğŸ˜¤ ç…©èº</div>
                            <div class="emotion-btn" data-emotion="å¥½å¥‡">ğŸ¤” å¥½å¥‡</div>
                            <div class="emotion-btn" data-emotion="çå€¦">ğŸ˜ª çå€¦</div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>å‚™è¨»</label>
                        <textarea id="emotion-note" placeholder="æƒ…ç·’åŸå› æˆ–è§€å¯Ÿ..."></textarea>
                    </div>
                    <button class="btn-primary" onclick="addEmotionRecord()">è¨˜éŒ„æƒ…ç·’</button>
                </div>

                <div class="record-form">
                    <h3>ğŸˆ ç¤¾æœƒäº’å‹•è¨˜éŒ„</h3>
                    <div class="form-group">
                        <label>äº’å‹•é¡å‹</label>
                        <select id="social-type">
                            <option>èˆ‡ç…§é¡§è€…äº’å‹•</option>
                            <option>èˆ‡å…¶ä»–å¬°å…’äº’å‹•</option>
                            <option>é™Œç”Ÿäººåæ‡‰</option>
                            <option>åœ˜é«”æ´»å‹•åƒèˆ‡</option>
                            <option>è‡ªä¸»éŠæˆ²</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>äº’å‹•è¡¨ç¾</label>
                        <textarea id="social-note" placeholder="æè¿°äº’å‹•æƒ…æ³ã€åæ‡‰ç­‰..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>è‡ªè¨‚äº’å‹•é¡å‹</label>
                        <div class="custom-input">
                            <input type="text" id="custom-social" placeholder="è¼¸å…¥è‡ªè¨‚é¡å‹">
                            <button onclick="addCustomSocial()">æ–°å¢</button>
                        </div>
                    </div>
                    <button class="btn-primary" onclick="addSocialRecord()">è¨˜éŒ„äº’å‹•</button>
                </div>
            </div>

            <!-- å¥åº·è¨˜éŒ„é é¢ -->
            <div class="tab-content" id="health">
                <div class="taiwan-vaccine-section">
                    <h4>ğŸ’‰ å°ç£å¬°å¹¼å…’ç–«è‹—æ¥ç¨®æ™‚ç¨‹</h4>
                    <div class="vaccine-schedule" id="vaccine-schedule">
                        <!-- ç–«è‹—æ™‚ç¨‹å°‡å‹•æ…‹ç”Ÿæˆ -->
                    </div>
                    <div class="form-group" style="margin-top: 15px;">
                        <label>ç–«è‹—æ¥ç¨®å‚™è¨»</label>
                        <textarea id="vaccine-notes" placeholder="æ¥ç¨®åæ‡‰ã€æ³¨æ„äº‹é …ç­‰..."></textarea>
                    </div>
                    <button class="btn-primary" onclick="saveVaccineRecord()">å„²å­˜ç–«è‹—è¨˜éŒ„</button>
                </div>

                <div class="record-form">
                    <h3>ğŸ“Š å¥åº·è¨˜éŒ„</h3>
                    <div class="form-group">
                        <label>è¨˜éŒ„æ™‚é–“</label>
                        <input type="datetime-local" id="health-time">
                    </div>
                    <div class="health-grid">
                        <div class="form-group">
                            <label>èº«é«˜</label>
                            <div class="health-input">
                                <input type="number" id="height" placeholder="50.0" step="0.1">
                                <span>å…¬åˆ†</span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>é«”é‡</label>
                            <div class="health-input">
                                <input type="number" id="weight" placeholder="3.50" step="0.01">
                                <span>å…¬æ–¤</span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>é ­åœ</label>
                            <div class="health-input">
                                <input type="number" id="head-circumference" placeholder="35.0" step="0.1">
                                <span>å…¬åˆ†</span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>é«”æº«</label>
                            <div class="health-input">
                                <input type="number" id="temperature" placeholder="36.5" step="0.1">
                                <span>Â°C</span>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>å‚™è¨»</label>
                        <textarea id="health-notes" placeholder="å¥åº·ç‹€æ³ã€é†«ç”Ÿå»ºè­°ç­‰..."></textarea>
                    </div>
                    <button class="btn-primary" onclick="addHealthRecord()">è¨˜éŒ„å¥åº·æ•¸æ“š</button>
                </div>

                <div id="health-history" class="health-chart">
                    <h4>ğŸ“ˆ å¥åº·ç´€éŒ„æ­·å²</h4>
                    <div id="health-records-list">
                        <p style="text-align: center; color: #6c757d; margin: 20px 0;">é‚„æ²’æœ‰å¥åº·è¨˜éŒ„</p>
                    </div>
                </div>
            </div>

            <!-- æ™‚é–“è»¸é é¢ -->
            <div class="tab-content" id="timeline">
                <div class="form-group">
                    <label>é¸æ“‡æ—¥æœŸ</label>
                    <input type="date" id="timeline-date" onchange="loadTimeline()">
                </div>
                <div id="timeline-content" class="timeline">
                    <p style="text-align: center; color: #6c757d; margin-top: 20px;">è«‹é¸æ“‡æ—¥æœŸæŸ¥çœ‹è¨˜éŒ„</p>
                </div>
            </div>

            <!-- æ—¥è¨˜é é¢ -->
            <div class="tab-content" id="diary">
                <div class="record-form">
                    <h3>ğŸ“ æ¯æ—¥æ—¥è¨˜</h3>
                    <div class="form-group">
                        <label>æ—¥æœŸ</label>
                        <input type="date" id="diary-date">
                    </div>
                    <div class="form-group">
                        <label>æ¨™é¡Œ</label>
                        <input type="text" id="diary-title" placeholder="ä»Šæ—¥é‡é»...">
                    </div>
                    <div class="form-group">
                        <label>å…§å®¹</label>
                        <textarea id="diary-content" placeholder="è¨˜éŒ„ä»Šå¤©çš„ç‰¹åˆ¥æ™‚åˆ»ã€æ–°ç™¼ç¾ã€æœ‰è¶£çš„äº‹æƒ…..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>ğŸ“· ç…§ç‰‡</label>
                        <div class="photo-upload" onclick="document.getElementById('photo-input').click()">
                            <p>ğŸ“± é»æ“Šä¸Šå‚³ç…§ç‰‡</p>
                            <input type="file" id="photo-input" style="display: none" accept="image/*" onchange="previewPhoto()">
                        </div>
                        <img id="photo-preview" class="photo-preview" style="display: none">
                    </div>
                    <button class="btn-primary" onclick="addDiaryEntry()">å„²å­˜æ—¥è¨˜</button>
                </div>
                
                <div id="diary-list"></div>
            </div>

            <!-- å ±è¡¨é é¢ -->
            <div class="tab-content" id="reports">
                <div class="form-group">
                    <label>å ±è¡¨æ—¥æœŸ</label>
                    <input type="date" id="report-date" onchange="generateReport()">
                </div>
                
                <div id="daily-stats" class="stats-grid">
                    <!-- çµ±è¨ˆå¡ç‰‡å°‡åœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->
                </div>
                
                <div id="weekly-report" style="margin-top: 20px;">
                    <!-- é€±å ±å…§å®¹ -->
                </div>
                
                <button class="btn-primary" onclick="exportReport()">åŒ¯å‡ºå ±è¡¨</button>
                
                <div style="margin-top: 20px; text-align: center;">
                    <button class="btn-primary" onclick="manualBackup()" style="margin: 5px;">ğŸ’¾ ä¸‹è¼‰å®Œæ•´å‚™ä»½</button>
                    <button class="btn-primary" onclick="loadBackup()" style="margin: 5px;">ğŸ“‚ è¼‰å…¥å‚™ä»½</button>
                    <button class="btn-primary" onclick="clearAllData()" style="margin: 5px; background: #dc3545;">ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰è³‡æ–™</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨åŸŸè®Šæ•¸
        let currentBaby = 0;
        let selectedEmotion = '';
        let selectedSide = '';
        let currentTimezone = 'Asia/Taipei';
        let babyData = {
            0: { name: 'å¯¶å¯¶A', profile: {}, records: [], diaries: [], healthRecords: [], vaccineRecords: [], developmentProgress: {} },
            1: { name: 'å¯¶å¯¶B', profile: {}, records: [], diaries: [], healthRecords: [], vaccineRecords: [], developmentProgress: {} },
            2: { name: 'å¯¶å¯¶C', profile: {}, records: [], diaries: [], healthRecords: [], vaccineRecords: [], developmentProgress: {} },
            3: { name: 'å¯¶å¯¶D', profile: {}, records: [], diaries: [], healthRecords: [], vaccineRecords: [], developmentProgress: {} }
        };

        // å°ç£ç–«è‹—æ¥ç¨®æ™‚ç¨‹
        const taiwanVaccineSchedule = [
            { age: 'å‡ºç”Ÿ24å°æ™‚å…§', vaccines: ['Bå‹è‚ç‚ç–«è‹—ç¬¬1åŠ‘', 'BCGç–«è‹—'], id: 'birth' },
            { age: 'å‡ºç”Ÿæ»¿1å€‹æœˆ', vaccines: ['Bå‹è‚ç‚ç–«è‹—ç¬¬2åŠ‘'], id: 'month1' },
            { age: 'å‡ºç”Ÿæ»¿2å€‹æœˆ', vaccines: ['ç™½å–‰ç ´å‚·é¢¨éç´°èƒæ€§ç™¾æ—¥å’³ã€bå‹å—œè¡€æ¡¿èŒåŠä¸æ´»åŒ–å°å…’éº»ç—ºäº”åˆä¸€ç–«è‹—ç¬¬1åŠ‘', '13åƒ¹çµåˆå‹è‚ºç‚éˆçƒèŒç–«è‹—ç¬¬1åŠ‘', 'è¼ªç‹€ç—…æ¯’ç–«è‹—ç¬¬1åŠ‘(è‡ªè²»)'], id: 'month2' },
            { age: 'å‡ºç”Ÿæ»¿4å€‹æœˆ', vaccines: ['ç™½å–‰ç ´å‚·é¢¨éç´°èƒæ€§ç™¾æ—¥å’³ã€bå‹å—œè¡€æ¡¿èŒåŠä¸æ´»åŒ–å°å…’éº»ç—ºäº”åˆä¸€ç–«è‹—ç¬¬2åŠ‘', '13åƒ¹çµåˆå‹è‚ºç‚éˆçƒèŒç–«è‹—ç¬¬2åŠ‘', 'è¼ªç‹€ç—…æ¯’ç–«è‹—ç¬¬2åŠ‘(è‡ªè²»)'], id: 'month4' },
            { age: 'å‡ºç”Ÿæ»¿6å€‹æœˆ', vaccines: ['ç™½å–‰ç ´å‚·é¢¨éç´°èƒæ€§ç™¾æ—¥å’³ã€bå‹å—œè¡€æ¡¿èŒåŠä¸æ´»åŒ–å°å…’éº»ç—ºäº”åˆä¸€ç–«è‹—ç¬¬3åŠ‘', 'Bå‹è‚ç‚ç–«è‹—ç¬¬3åŠ‘'], id: 'month6' },
            { age: 'å‡ºç”Ÿæ»¿12å€‹æœˆ', vaccines: ['éº»ç–¹è…®è…ºç‚å¾·åœ‹éº»ç–¹æ··åˆç–«è‹—ç¬¬1åŠ‘', 'æ°´ç—˜ç–«è‹—', '13åƒ¹çµåˆå‹è‚ºç‚éˆçƒèŒç–«è‹—ç¬¬3åŠ‘', 'Aå‹è‚ç‚ç–«è‹—ç¬¬1åŠ‘(è‡ªè²»)'], id: 'month12' },
            { age: 'å‡ºç”Ÿæ»¿15å€‹æœˆ', vaccines: ['ç™½å–‰ç ´å‚·é¢¨éç´°èƒæ€§ç™¾æ—¥å’³ã€bå‹å—œè¡€æ¡¿èŒåŠä¸æ´»åŒ–å°å…’éº»ç—ºäº”åˆä¸€ç–«è‹—ç¬¬4åŠ‘'], id: 'month15' },
            { age: 'å‡ºç”Ÿæ»¿18å€‹æœˆ', vaccines: ['Aå‹è‚ç‚ç–«è‹—ç¬¬2åŠ‘(è‡ªè²»)'], id: 'month18' },
            { age: 'å‡ºç”Ÿæ»¿27å€‹æœˆ', vaccines: ['æ—¥æœ¬è…¦ç‚ç–«è‹—ç¬¬1åŠ‘'], id: 'month27' },
            { age: 'æ»¿5æ­²è‡³å…¥å°å­¸å‰', vaccines: ['ç™½å–‰ç ´å‚·é¢¨éç´°èƒæ€§ç™¾æ—¥å’³åŠä¸æ´»åŒ–å°å…’éº»ç—ºæ··åˆç–«è‹—', 'éº»ç–¹è…®è…ºç‚å¾·åœ‹éº»ç–¹æ··åˆç–«è‹—ç¬¬2åŠ‘', 'æ—¥æœ¬è…¦ç‚ç–«è‹—ç¬¬2åŠ‘'], id: 'preschool' }
        ];

        // ç™¼å±•é‡Œç¨‹ç¢‘è³‡æ–™ï¼ˆå«äº’å‹•æ´»å‹•å»ºè­°ï¼‰
        const milestones = {
            0: {
                title: "0-3å€‹æœˆ ç™¼å±•æŒ‡æ¨™",
                items: [
                    "æœƒæ³¨è¦–äººè‡‰å’Œç‰©å“",
                    "è½åˆ°è²éŸ³æœƒè½‰é ­", 
                    "æœƒå¾®ç¬‘å›æ‡‰",
                    "è¶´è‘—æ™‚èƒ½çŸ­æš«æŠ¬é ­",
                    "æ‰‹æœƒæ¡æ‹³ï¼Œå¶ç„¶å¼µé–‹"
                ],
                activities: [
                    "èˆ‡å¯¶å¯¶é€²è¡Œçœ¼ç¥æ¥è§¸å°è©±",
                    "æ’­æ”¾è¼•æŸ”éŸ³æ¨‚æˆ–å”±æ­Œçµ¦å¯¶å¯¶è½", 
                    "ä½¿ç”¨é»‘ç™½å°æ¯”å¡ç‰‡åˆºæ¿€è¦–è¦º",
                    "è¼•è¼•æŒ‰æ‘©å¯¶å¯¶çš„æ‰‹è…³",
                    "è®“å¯¶å¯¶ç·´ç¿’è¶´è‘—æŠ¬é ­"
                ]
            },
            3: {
                title: "3-6å€‹æœˆ ç™¼å±•æŒ‡æ¨™", 
                items: [
                    "æœƒç¿»èº«ï¼ˆä»°èººç¿»è¶´è‘—ï¼‰",
                    "èƒ½åè‘—éœ€è¦æ”¯æ’",
                    "æœƒä¼¸æ‰‹æŠ“å–ç‰©å“",
                    "æœƒç™¼å‡ºå’¿å’¿å‘€å‘€è²éŸ³",
                    "èªå¾—ç†Ÿæ‚‰çš„äºº",
                    "å°é¡å­ä¸­çš„è‡ªå·±æ„Ÿèˆˆè¶£"
                ],
                activities: [
                    "æä¾›å®‰å…¨çš„æ–éˆ´å’ŒæŠ“æ¡ç©å…·",
                    "å’Œå¯¶å¯¶é€²è¡Œå’¿å’¿å‘€å‘€å°è©±",
                    "è®“å¯¶å¯¶ç…§é¡å­èªè­˜è‡ªå·±",
                    "å”åŠ©å¯¶å¯¶ç·´ç¿’ç¿»èº«å‹•ä½œ",
                    "å”±å…’æ­Œé…åˆæ‰‹å‹¢å‹•ä½œ"
                ]
            },
            6: {
                title: "6-9å€‹æœˆ ç™¼å±•æŒ‡æ¨™",
                items: [
                    "èƒ½ç¨ç«‹åç©©",
                    "æœƒçˆ¬è¡Œæˆ–æŒªå‹•",
                    "æœƒç”¨æ‰‹æŒ‡æŠ“å°ç‰©å“",
                    "æœƒèªªç°¡å–®éŸ³ç¯€ï¼ˆå¦‚ï¼šmamaã€dadaï¼‰",
                    "æœƒç©èº²è²“è²“éŠæˆ²",
                    "å°é™Œç”Ÿäººæœ‰è­¦è¦º"
                ],
                activities: [
                    "ç©èº²è²“è²“éŠæˆ²",
                    "æä¾›ä¸åŒè³ªæ„Ÿçš„ç©å…·æ¢ç´¢",
                    "é¼“å‹µå¯¶å¯¶çˆ¬è¡Œæ¢ç´¢ç’°å¢ƒ",
                    "ç·´ç¿’ç”¨æ‰‹æŒ‡æ‹¿å°é»å¿ƒ",
                    "è®€ç°¡å–®çš„åœ–ç•«æ›¸çµ¦å¯¶å¯¶è½"
                ]
            },
            9: {
                title: "9-12å€‹æœˆ ç™¼å±•æŒ‡æ¨™",
                items: [
                    "æœƒæ‰¶è‘—æ±è¥¿ç«™ç«‹",
                    "å¯èƒ½æœƒèµ°å¹¾æ­¥",
                    "æœƒæ®æ‰‹èªªå†è¦‹",
                    "èƒ½ç†è§£ç°¡å–®æŒ‡ä»¤",
                    "æœƒæ¨¡ä»¿å¤§äººå‹•ä½œ",
                    "é–‹å§‹æœ‰è‡ªæˆ‘æ„è­˜"
                ],
                activities: [
                    "æ•™å¯¶å¯¶æ®æ‰‹èªªå†è¦‹",
                    "ç©æ‹æ‰‹æ­Œå’Œæ‰‹æŒ‡è¬ ",
                    "æä¾›æ¨æ‹‰ç©å…·å”åŠ©èµ°è·¯",
                    "ç·´ç¿’ç°¡å–®çš„æŒ‡ä»¤éŠæˆ²",
                    "è®“å¯¶å¯¶æ¨¡ä»¿æ‹æ‰‹ã€æ“ºæ‰‹å‹•ä½œ"
                ]
            },
            12: {
                title: "12-18å€‹æœˆ ç™¼å±•æŒ‡æ¨™",
                items: [
                    "èƒ½ç¨ç«‹è¡Œèµ°",
                    "æœƒèªªå¹¾å€‹æœ‰æ„ç¾©çš„å­—",
                    "èƒ½ç”¨æ¯å­å–æ°´",
                    "æœƒç”¨å‹ºå­åƒé£¯ï¼ˆé›–ç„¶ä¸ç†Ÿç·´ï¼‰",
                    "å–œæ­¡æ¢ç´¢ç’°å¢ƒ",
                    "é–‹å§‹è¡¨ç¾åˆ†é›¢ç„¦æ…®"
                ],
                activities: [
                    "æä¾›å®‰å…¨çš„æ¢ç´¢ç©ºé–“",
                    "æ•™å¯¶å¯¶èªªç°¡å–®è©å½™",
                    "ç·´ç¿’ä½¿ç”¨æ¹¯åŒ™å’Œæ¯å­",
                    "ç©ç°¡å–®çš„ç©æœ¨ç–Šç–Šæ¨‚",
                    "å»ºç«‹å›ºå®šçš„å‘Šåˆ¥å„€å¼"
                ]
            },
            18: {
                title: "18-24å€‹æœˆ ç™¼å±•æŒ‡æ¨™",
                items: [
                    "èƒ½è·‘æ­¥å’Œè·³èº",
                    "è©å½™é‡å¿«é€Ÿå¢åŠ ",
                    "æœƒå †ç–Šç©æœ¨",
                    "é–‹å§‹å¦‚å»è¨“ç·´æº–å‚™",
                    "å–œæ­¡æ¨¡ä»¿éŠæˆ²",
                    "é–‹å§‹è¡¨ç¾åŒç†å¿ƒ"
                ],
                activities: [
                    "æä¾›å¤šæ¨£åŒ–çš„ç©æœ¨éŠæˆ²",
                    "é–±è®€æ•…äº‹æ›¸å¢åŠ è©å½™",
                    "ç©è§’è‰²æ‰®æ¼”éŠæˆ²",
                    "æ•™å°ç°¡å–®çš„ç”Ÿæ´»è‡ªç†",
                    "ç·´ç¿’è·‘è·³ç­‰å¤§è‚Œè‚‰å‹•ä½œ"
                ]
            }
        };

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            checkStorageSupport();
            loadAllData();
            setCurrentTimeWithTimezone(currentTimezone);
            setupEventListeners();
            loadBabyProfile();
            loadHealthRecords();
            loadVaccineSchedule();
            loadDevelopmentProgress();
            
            // è¨­å®šé è¨­æ—¥æœŸ
            const today = getCurrentDateByTimezone(currentTimezone);
            document.getElementById('timeline-date').value = today;
            document.getElementById('diary-date').value = today;
            document.getElementById('report-date').value = today;
            
            // åˆå§‹åŒ–å‚™ä»½ç‹€æ…‹
            setTimeout(() => {
                updateBackupStatus(true);
                updateStorageInfo();
            }, 1000);
        }

        // æ™‚å€è™•ç†åŠŸèƒ½
        function updateTimezone() {
            currentTimezone = document.getElementById('timezone-select').value;
            setCurrentTimeWithTimezone(currentTimezone);
            
            // æ›´æ–°æ—¥æœŸæ¬„ä½
            const today = getCurrentDateByTimezone(currentTimezone);
            document.getElementById('timeline-date').value = today;
            document.getElementById('diary-date').value = today;
            document.getElementById('report-date').value = today;
            
            saveAllData();
        }

        function getCurrentDateByTimezone(timezone) {
            const now = new Date();
            const formatter = new Intl.DateTimeFormat('sv-SE', { 
                timeZone: timezone,
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
            return formatter.format(now);
        }

        function getCurrentDateTimeByTimezone(timezone) {
            const now = new Date();
            const date = getCurrentDateByTimezone(timezone);
            const time = now.toLocaleTimeString('sv-SE', { 
                timeZone: timezone,
                hour12: false,
                hour: '2-digit',
                minute: '2-digit'
            });
            return `${date}T${time}`;
        }

        function setCurrentTimeWithTimezone(timezone) {
            const currentDateTime = getCurrentDateTimeByTimezone(timezone);
            
            document.getElementById('feed-time').value = currentDateTime;
            document.getElementById('sleep-start').value = currentDateTime;
            document.getElementById('sleep-end').value = currentDateTime;
            document.getElementById('diaper-time').value = currentDateTime;
            document.getElementById('health-time').value = currentDateTime;
        }

        // è³‡æ–™å„²å­˜æª¢æŸ¥
        function checkStorageSupport() {
            const storageStatus = document.getElementById('storage-status');
            
            try {
                if (typeof(Storage) !== "undefined" && localStorage) {
                    storageStatus.textContent = 'âœ… æœ¬æ©Ÿå„²å­˜å¯ç”¨ - è³‡æ–™æœƒè‡ªå‹•ä¿å­˜';
                    storageStatus.style.color = '#28a745';
                } else {
                    storageStatus.textContent = 'âš ï¸ æœ¬æ©Ÿå„²å­˜ä¸å¯ç”¨ - è«‹å®šæœŸå‚™ä»½';
                    storageStatus.style.color = '#ffc107';
                }
            } catch (e) {
                storageStatus.textContent = 'âŒ å„²å­˜åŠŸèƒ½ç•°å¸¸ - åƒ…é™è¨˜æ†¶é«”æš«å­˜';
                storageStatus.style.color = '#dc3545';
            }
        }

        function updateStorageInfo() {
            try {
                const data = JSON.stringify(babyData);
                const sizeInBytes = new Blob([data]).size;
                const sizeInKB = (sizeInBytes / 1024).toFixed(2);
                
                document.getElementById('storage-size').textContent = `ä½¿ç”¨ç©ºé–“: ${sizeInKB} KB`;
                
                // æª¢æŸ¥æ˜¯å¦æ¥è¿‘å„²å­˜é™åˆ¶ (é€šå¸¸ 5-10MB)
                if (sizeInBytes > 1024 * 1024) { // 1MB
                    document.getElementById('storage-size').style.color = '#ffc107';
                    document.getElementById('storage-size').textContent += ' (å»ºè­°å‚™ä»½)';
                }
            } catch (e) {
                document.getElementById('storage-size').textContent = 'å¤§å°: ç„¡æ³•è¨ˆç®—';
            }
        }

        // ç–«è‹—æ¥ç¨®åŠŸèƒ½
        function loadVaccineSchedule() {
            const scheduleContainer = document.getElementById('vaccine-schedule');
            const currentBabyVaccines = babyData[currentBaby].vaccineRecords || [];
            
            scheduleContainer.innerHTML = taiwanVaccineSchedule.map(schedule => {
                const vaccineItems = schedule.vaccines.map(vaccine => {
                    const isCompleted = currentBabyVaccines.some(record => 
                        record.vaccine === vaccine && record.completed
                    );
                    
                    return `
                        <div class="vaccine-checkbox">
                            <input type="checkbox" id="${schedule.id}_${vaccine}" 
                                   ${isCompleted ? 'checked' : ''} 
                                   onchange="updateVaccineStatus('${vaccine}', this.checked)">
                            <label for="${schedule.id}_${vaccine}">${vaccine}</label>
                        </div>
                    `;
                }).join('');

                return `
                    <div class="vaccine-item">
                        <div class="vaccine-age">${schedule.age}</div>
                        <div class="vaccine-name">${vaccineItems}</div>
                    </div>
                `;
            }).join('');
        }

        function updateVaccineStatus(vaccine, completed) {
            if (!babyData[currentBaby].vaccineRecords) {
                babyData[currentBaby].vaccineRecords = [];
            }
            
            const existingRecord = babyData[currentBaby].vaccineRecords.find(r => r.vaccine === vaccine);
            
            if (existingRecord) {
                existingRecord.completed = completed;
                existingRecord.date = getCurrentDateByTimezone(currentTimezone);
            } else {
                babyData[currentBaby].vaccineRecords.push({
                    vaccine: vaccine,
                    completed: completed,
                    date: getCurrentDateByTimezone(currentTimezone)
                });
            }
            
            saveAllData();
        }

        function saveVaccineRecord() {
            const notes = document.getElementById('vaccine-notes').value;
            
            if (notes.trim()) {
                const record = {
                    id: Date.now(),
                    type: 'ç–«è‹—æ¥ç¨®',
                    time: getCurrentDateTimeByTimezone(currentTimezone),
                    data: { notes: notes }
                };

                babyData[currentBaby].records.push(record);
                document.getElementById('vaccine-notes').value = '';
                
                saveAllData();
                showBackupStatus();
                alert('ç–«è‹—è¨˜éŒ„å·²ä¿å­˜ï¼');
            }
        }

        // ç™¼å±•é€²åº¦è¿½è¹¤
        function loadDevelopmentProgress() {
            const profile = babyData[currentBaby].profile;
            if (!profile.birthday) return;

            const ageInMonths = calculateAgeInMonths(profile.birthday);
            const developmentChecklist = document.getElementById('development-checklist');
            
            // æ‰¾åˆ°é©åˆçš„é‡Œç¨‹ç¢‘éšæ®µ
            let appropriateMilestone = null;
            const milestoneKeys = Object.keys(milestones).map(Number).sort((a, b) => a - b);
            
            for (let i = milestoneKeys.length - 1; i >= 0; i--) {
                if (ageInMonths >= milestoneKeys[i]) {
                    appropriateMilestone = milestones[milestoneKeys[i]];
                    break;
                }
            }

            if (appropriateMilestone) {
                const currentProgress = babyData[currentBaby].developmentProgress || {};
                
                developmentChecklist.innerHTML = appropriateMilestone.items.map((item, index) => {
                    const itemId = `dev_${ageInMonths}_${index}`;
                    const isCompleted = currentProgress[itemId] || false;
                    
                    return `
                        <div class="development-item">
                            <input type="checkbox" id="${itemId}" 
                                   ${isCompleted ? 'checked' : ''} 
                                   onchange="updateDevelopmentProgress('${itemId}', this.checked)">
                            <label for="${itemId}">${item}</label>
                        </div>
                    `;
                }).join('');
            } else {
                developmentChecklist.innerHTML = '<p style="text-align: center; color: #666;">è«‹è¨­å®šå‡ºç”Ÿæ—¥æœŸä»¥é¡¯ç¤ºç™¼å±•æŒ‡æ¨™</p>';
            }
        }

        function updateDevelopmentProgress(itemId, completed) {
            if (!babyData[currentBaby].developmentProgress) {
                babyData[currentBaby].developmentProgress = {};
            }
            
            babyData[currentBaby].developmentProgress[itemId] = completed;
            saveAllData();
        }

        function calculateAgeInMonths(birthday) {
            const birthDate = new Date(birthday);
            const today = new Date();
            return Math.floor((today - birthDate) / (1000 * 60 * 60 * 24 * 30.44));
        }

        function setupEventListeners() {
            // å¬°å…’é¸æ“‡
            document.querySelectorAll('.baby-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.baby-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentBaby = parseInt(this.dataset.baby);
                    loadBabyProfile();
                    loadHealthRecords();
                    loadVaccineSchedule();
                    loadDevelopmentProgress();
                    loadTimeline();
                    loadDiaries();
                    generateReport();
                });
            });

            // åˆ†é åˆ‡æ›
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    this.classList.add('active');
                    document.getElementById(this.dataset.tab).classList.add('active');
                    
                    // è¼‰å…¥å°æ‡‰é é¢æ•¸æ“š
                    if (this.dataset.tab === 'health') {
                        loadHealthRecords();
                        loadVaccineSchedule();
                    }
                });
            });

            // æƒ…ç·’é¸æ“‡
            document.querySelectorAll('.emotion-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.emotion-btn').forEach(b => b.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedEmotion = this.dataset.emotion;
                });
            });

            // è¦ªé¤µå´åˆ¥é¸æ“‡
            document.querySelectorAll('.side-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.side-btn').forEach(b => b.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedSide = this.dataset.side;
                });
            });
        }

        // å€‹äººè³‡æ–™åŠŸèƒ½
        function updateBabyPhoto() {
            const input = document.getElementById('photo-input-profile');
            const photo = document.getElementById('baby-photo');
            
            if (input.files && input.files[0]) {
                // æª¢æŸ¥æª”æ¡ˆå¤§å° (é™åˆ¶ 2MB)
                if (input.files[0].size > 2 * 1024 * 1024) {
                    alert('ç…§ç‰‡æª”æ¡ˆéå¤§ï¼Œè«‹é¸æ“‡å°æ–¼ 2MB çš„ç…§ç‰‡');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    photo.src = e.target.result;
                    babyData[currentBaby].profile.photo = e.target.result;
                    saveBabyProfile();
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function updateBabyName() {
            const name = document.getElementById('baby-name').value;
            babyData[currentBaby].name = name || `å¯¶å¯¶${String.fromCharCode(65 + currentBaby)}`;
            babyData[currentBaby].profile.name = name;
            
            // æ›´æ–°æŒ‰éˆ•é¡¯ç¤º
            document.querySelector(`.baby-btn[data-baby="${currentBaby}"]`).textContent = babyData[currentBaby].name;
            saveBabyProfile();
        }

        function calculateAge() {
            const birthday = document.getElementById('baby-birthday').value;
            if (!birthday) {
                document.getElementById('age-display').textContent = 'è«‹è¨­å®šå‡ºç”Ÿæ—¥æœŸä¾†è¨ˆç®—æœˆé½¡';
                document.getElementById('current-milestones').style.display = 'none';
                return;
            }

            const birthDate = new Date(birthday);
            const today = new Date();
            const ageInMonths = Math.floor((today - birthDate) / (1000 * 60 * 60 * 24 * 30.44));
            const ageInDays = Math.floor((today - birthDate) / (1000 * 60 * 60 * 24));

            let ageText = '';
            if (ageInMonths < 1) {
                ageText = `${ageInDays} å¤©å¤§`;
            } else if (ageInMonths < 12) {
                ageText = `${ageInMonths} å€‹æœˆå¤§`;
            } else {
                const years = Math.floor(ageInMonths / 12);
                const months = ageInMonths % 12;
                ageText = `${years} æ­² ${months} å€‹æœˆå¤§`;
            }

            document.getElementById('age-display').textContent = ageText;
            babyData[currentBaby].profile.birthday = birthday;
            babyData[currentBaby].profile.ageInMonths = ageInMonths;

            // é¡¯ç¤ºç›¸æ‡‰çš„ç™¼å±•æŒ‡æ¨™
            showCurrentMilestones(ageInMonths);
            loadDevelopmentProgress();
            saveBabyProfile();
        }

        function showCurrentMilestones(ageInMonths) {
            const milestoneContainer = document.getElementById('current-milestones');
            const milestoneContent = document.getElementById('milestone-content');

            // æ‰¾åˆ°é©åˆçš„é‡Œç¨‹ç¢‘éšæ®µ
            let appropriateMilestone = null;
            const milestoneKeys = Object.keys(milestones).map(Number).sort((a, b) => a - b);
            
            for (let i = milestoneKeys.length - 1; i >= 0; i--) {
                if (ageInMonths >= milestoneKeys[i]) {
                    appropriateMilestone = milestones[milestoneKeys[i]];
                    break;
                }
            }

            if (appropriateMilestone) {
                milestoneContent.innerHTML = `
                    <h5>${appropriateMilestone.title}</h5>
                    <ul class="milestone-list">
                        ${appropriateMilestone.items.map(item => `<li>${item}</li>`).join('')}
                    </ul>
                    <div class="activity-section">
                        <h5>ğŸ¯ å»ºè­°äº’å‹•æ´»å‹•</h5>
                        <ul class="milestone-list">
                            ${appropriateMilestone.activities.map(activity => `<li>${activity}</li>`).join('')}
                        </ul>
                    </div>
                `;
                milestoneContainer.style.display = 'block';
            } else {
                milestoneContainer.style.display = 'none';
            }
        }

        function saveBabyProfile() {
            const profile = {
                name: document.getElementById('baby-name').value,
                birthday: document.getElementById('baby-birthday').value,
                gender: document.getElementById('baby-gender').value,
                notes: document.getElementById('baby-notes').value,
                photo: babyData[currentBaby].profile.photo || null
            };
            
            babyData[currentBaby].profile = profile;
            saveAllData();
        }

        function loadBabyProfile() {
            const profile = babyData[currentBaby].profile || {};
            
            document.getElementById('baby-name').value = profile.name || '';
            document.getElementById('baby-birthday').value = profile.birthday || '';
            document.getElementById('baby-gender').value = profile.gender || '';
            document.getElementById('baby-notes').value = profile.notes || '';
            
            if (profile.photo) {
                document.getElementById('baby-photo').src = profile.photo;
            } else {
                document.getElementById('baby-photo').src = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='120' viewBox='0 0 120 120'%3E%3Ccircle cx='60' cy='60' r='60' fill='%23f0f0f0'/%3E%3Ctext x='60' y='70' text-anchor='middle' font-size='40' fill='%23999'%3EğŸ‘¶%3C/text%3E%3C/svg%3E";
            }

            if (profile.birthday) {
                calculateAge();
            }
        }

        // å¥åº·è¨˜éŒ„åŠŸèƒ½
        function addHealthRecord() {
            const time = document.getElementById('health-time').value;
            const height = document.getElementById('height').value;
            const weight = document.getElementById('weight').value;
            const headCircumference = document.getElementById('head-circumference').value;
            const temperature = document.getElementById('temperature').value;
            const notes = document.getElementById('health-notes').value;
            
            if (!time) {
                alert('è«‹é¸æ“‡è¨˜éŒ„æ™‚é–“');
                return;
            }

            if (!height && !weight && !headCircumference && !temperature) {
                alert('è«‹è‡³å°‘å¡«å¯«ä¸€é …å¥åº·æ•¸æ“š');
                return;
            }

            const healthRecord = {
                id: Date.now(),
                time: time,
                height: height ? parseFloat(height) : null,
                weight: weight ? parseFloat(weight) : null,
                headCircumference: headCircumference ? parseFloat(headCircumference) : null,
                temperature: temperature ? parseFloat(temperature) : null,
                notes: notes,
                timezone: currentTimezone
            };

            babyData[currentBaby].healthRecords.push(healthRecord);
            saveAllData();
            
            // æ¸…ç©ºè¡¨å–®
            document.getElementById('height').value = '';
            document.getElementById('weight').value = '';
            document.getElementById('head-circumference').value = '';
            document.getElementById('temperature').value = '';
            document.getElementById('health-notes').value = '';
            setCurrentTimeWithTimezone(currentTimezone);
            
            loadHealthRecords();
            showBackupStatus();
            alert('å¥åº·è¨˜éŒ„å·²ä¿å­˜ï¼');
        }

        function loadHealthRecords() {
            const recordsList = document.getElementById('health-records-list');
            const healthRecords = babyData[currentBaby].healthRecords.sort((a, b) => new Date(b.time) - new Date(a.time));
            
            if (healthRecords.length === 0) {
                recordsList.innerHTML = '<p style="text-align: center; color: #6c757d; margin: 20px 0;">é‚„æ²’æœ‰å¥åº·è¨˜éŒ„</p>';
                return;
            }

            recordsList.innerHTML = healthRecords.map(record => {
                const date = new Date(record.time).toLocaleDateString('zh-TW', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    timeZone: record.timezone || currentTimezone
                });
                
                let measurements = [];
                if (record.height) measurements.push(`èº«é«˜: ${record.height}cm`);
                if (record.weight) measurements.push(`é«”é‡: ${record.weight}kg`);
                if (record.headCircumference) measurements.push(`é ­åœ: ${record.headCircumference}cm`);
                if (record.temperature) measurements.push(`é«”æº«: ${record.temperature}Â°C`);
                
                return `
                    <div class="health-record">
                        <div>
                            <strong>${date}</strong><br>
                            <small style="color: #666;">${measurements.join(' | ')}</small>
                            ${record.notes ? `<br><small style="color: #888;">${record.notes}</small>` : ''}
                        </div>
                        <button onclick="deleteHealthRecord(${record.id})" style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">åˆªé™¤</button>
                    </div>
                `;
            }).join('');
        }

        function deleteHealthRecord(recordId) {
            if (confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†å¥åº·è¨˜éŒ„å—ï¼Ÿ')) {
                babyData[currentBaby].healthRecords = babyData[currentBaby].healthRecords.filter(r => r.id !== recordId);
                saveAllData();
                loadHealthRecords();
                alert('å¥åº·è¨˜éŒ„å·²åˆªé™¤');
            }
        }

        // é¤µé£ŸåŠŸèƒ½
        function toggleBreastfeedOptions() {
            const feedType = document.getElementById('feed-type').value;
            const breastfeedOptions = document.getElementById('breastfeed-options');
            const formulaAmount = document.getElementById('formula-amount');

            if (feedType === 'breast') {
                breastfeedOptions.style.display = 'block';
                formulaAmount.style.display = 'none';
            } else {
                breastfeedOptions.style.display = 'none';
                formulaAmount.style.display = 'block';
            }
        }

        function addFeedRecord() {
            const time = document.getElementById('feed-time').value;
            const type = document.getElementById('feed-type').value;
            
            if (!time) {
                alert('è«‹é¸æ“‡æ™‚é–“');
                return;
            }

            let feedData = { feedType: type };

            if (type === 'breast') {
                if (!selectedSide) {
                    alert('è«‹é¸æ“‡é¤µé£Ÿå´åˆ¥');
                    return;
                }
                const minutes = document.getElementById('feed-minutes').value;
                if (!minutes) {
                    alert('è«‹è¼¸å…¥é¤µé£Ÿæ™‚é–“');
                    return;
                }
                feedData.side = selectedSide;
                feedData.duration = parseInt(minutes);
            } else {
                const amount = document.getElementById('feed-amount').value;
                feedData.amount = amount || 'æœªè¨˜éŒ„';
            }

            const record = {
                id: Date.now(),
                type: 'é¤µé£Ÿ',
                time: time,
                data: feedData,
                timezone: currentTimezone
            };

            babyData[currentBaby].records.push(record);
            saveAllData();
            
            // æ¸…ç©ºè¡¨å–®
            document.getElementById('feed-amount').value = '';
            document.getElementById('feed-minutes').value = '';
            document.querySelectorAll('.side-btn').forEach(b => b.classList.remove('selected'));
            selectedSide = '';
            setCurrentTimeWithTimezone(currentTimezone);
            
            showBackupStatus();
            alert('é¤µé£Ÿè¨˜éŒ„å·²ä¿å­˜ï¼');
        }

        function addSleepRecord() {
            const start = document.getElementById('sleep-start').value;
            const end = document.getElementById('sleep-end').value;
            const quality = document.getElementById('sleep-quality').value;
            
            if (!start || !end) {
                alert('è«‹é¸æ“‡é–‹å§‹å’ŒçµæŸæ™‚é–“');
                return;
            }

            if (new Date(end) <= new Date(start)) {
                alert('çµæŸæ™‚é–“å¿…é ˆæ™šæ–¼é–‹å§‹æ™‚é–“');
                return;
            }

            const duration = calculateDuration(start, end);
            
            const record = {
                id: Date.now(),
                type: 'ç¡çœ ',
                time: start,
                data: { start, end, quality, duration },
                timezone: currentTimezone
            };

            babyData[currentBaby].records.push(record);
            saveAllData();
            
            setCurrentTimeWithTimezone(currentTimezone);
            showBackupStatus();
            alert('ç¡çœ è¨˜éŒ„å·²ä¿å­˜ï¼');
        }

        function addDiaperRecord() {
            const time = document.getElementById('diaper-time').value;
            const type = document.getElementById('diaper-type').value;
            
            if (!time) {
                alert('è«‹é¸æ“‡æ™‚é–“');
                return;
            }

            const record = {
                id: Date.now(),
                type: 'æ›å°¿å¸ƒ',
                time: time,
                data: { diaperType: type },
                timezone: currentTimezone
            };

            babyData[currentBaby].records.push(record);
            saveAllData();
            
            setCurrentTimeWithTimezone(currentTimezone);
            showBackupStatus();
            alert('æ›å°¿å¸ƒè¨˜éŒ„å·²ä¿å­˜ï¼');
        }

        function addEmotionRecord() {
            if (!selectedEmotion) {
                alert('è«‹é¸æ“‡æƒ…ç·’');
                return;
            }

            const note = document.getElementById('emotion-note').value;
            
            const record = {
                id: Date.now(),
                type: 'æƒ…ç·’',
                time: getCurrentDateTimeByTimezone(currentTimezone),
                data: { emotion: selectedEmotion, note },
                timezone: currentTimezone
            };

            babyData[currentBaby].records.push(record);
            saveAllData();
            
            // æ¸…ç©ºè¡¨å–®
            document.querySelectorAll('.emotion-btn').forEach(b => b.classList.remove('selected'));
            document.getElementById('emotion-note').value = '';
            selectedEmotion = '';
            
            showBackupStatus();
            alert('æƒ…ç·’è¨˜éŒ„å·²ä¿å­˜ï¼');
        }

        function addSocialRecord() {
            const type = document.getElementById('social-type').value;
            const note = document.getElementById('social-note').value;
            
            if (!note.trim()) {
                alert('è«‹å¡«å¯«äº’å‹•æè¿°');
                return;
            }

            const record = {
                id: Date.now(),
                type: 'ç¤¾æœƒäº’å‹•',
                time: getCurrentDateTimeByTimezone(currentTimezone),
                data: { socialType: type, note },
                timezone: currentTimezone
            };

            babyData[currentBaby].records.push(record);
            saveAllData();
            
            document.getElementById('social-note').value = '';
            showBackupStatus();
            alert('ç¤¾æœƒäº’å‹•è¨˜éŒ„å·²ä¿å­˜ï¼');
        }

        function addCustomSocial() {
            const customType = document.getElementById('custom-social').value.trim();
            if (!customType) return;
            
            const select = document.getElementById('social-type');
            const option = document.createElement('option');
            option.value = customType;
            option.textContent = customType;
            select.appendChild(option);
            select.value = customType;
            
            document.getElementById('custom-social').value = '';
        }

        // æ—¥è¨˜åŠŸèƒ½
        function previewPhoto() {
            const input = document.getElementById('photo-input');
            const preview = document.getElementById('photo-preview');
            
            if (input.files && input.files[0]) {
                // æª¢æŸ¥æª”æ¡ˆå¤§å°
                if (input.files[0].size > 3 * 1024 * 1024) {
                    alert('ç…§ç‰‡æª”æ¡ˆéå¤§ï¼Œè«‹é¸æ“‡å°æ–¼ 3MB çš„ç…§ç‰‡');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function addDiaryEntry() {
            const date = document.getElementById('diary-date').value;
            const title = document.getElementById('diary-title').value;
            const content = document.getElementById('diary-content').value;
            const photoPreview = document.getElementById('photo-preview');
            
            if (!date || !title || !content) {
                alert('è«‹å¡«å¯«å®Œæ•´è³‡æ–™');
                return;
            }

            const diary = {
                id: Date.now(),
                date: date,
                title: title,
                content: content,
                photo: photoPreview.style.display !== 'none' ? photoPreview.src : null,
                timestamp: new Date().toISOString(),
                timezone: currentTimezone
            };

            babyData[currentBaby].diaries.push(diary);
            saveAllData();
            
            // æ¸…ç©ºè¡¨å–®
            document.getElementById('diary-title').value = '';
            document.getElementById('diary-content').value = '';
            document.getElementById('photo-preview').style.display = 'none';
            document.getElementById('photo-input').value = '';
            
            loadDiaries();
            showBackupStatus();
            alert('æ—¥è¨˜å·²ä¿å­˜ï¼');
        }

        function loadDiaries() {
            const diaryList = document.getElementById('diary-list');
            const diaries = babyData[currentBaby].diaries.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            if (diaries.length === 0) {
                diaryList.innerHTML = '<p style="text-align: center; color: #6c757d; margin-top: 20px;">é‚„æ²’æœ‰æ—¥è¨˜è¨˜éŒ„</p>';
                return;
            }

            diaryList.innerHTML = diaries.map(diary => `
                <div class="timeline-item">
                    <div class="timeline-time">${formatDate(diary.date)}</div>
                    <div class="timeline-type">ğŸ“ ${diary.title}</div>
                    <div class="timeline-content">
                        ${diary.content}
                        ${diary.photo ? `<img src="${diary.photo}" class="photo-preview" style="display: block; margin-top: 10px;">` : ''}
                    </div>
                    <button onclick="deleteDiary(${diary.id})" style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; margin-top: 10px;">åˆªé™¤æ—¥è¨˜</button>
                </div>
            `).join('');
        }

        function deleteDiary(diaryId) {
            if (confirm('ç¢ºå®šè¦åˆªé™¤é€™ç¯‡æ—¥è¨˜å—ï¼Ÿ')) {
                babyData[currentBaby].diaries = babyData[currentBaby].diaries.filter(d => d.id !== diaryId);
                saveAllData();
                loadDiaries();
                alert('æ—¥è¨˜å·²åˆªé™¤');
            }
        }

        // æ™‚é–“è»¸åŠŸèƒ½
        function loadTimeline() {
            const selectedDate = document.getElementById('timeline-date').value;
            if (!selectedDate) return;

            const allRecords = [
                ...babyData[currentBaby].records,
                ...babyData[currentBaby].healthRecords.map(hr => ({
                    id: hr.id,
                    type: 'å¥åº·è¨˜éŒ„',
                    time: hr.time,
                    data: hr,
                    timezone: hr.timezone
                }))
            ];

            const records = allRecords.filter(record => {
                const recordDate = new Date(record.time).toISOString().split('T')[0];
                return recordDate === selectedDate;
            }).sort((a, b) => new Date(b.time) - new Date(a.time));

            const timelineContent = document.getElementById('timeline-content');
            
            if (records.length === 0) {
                timelineContent.innerHTML = '<p style="text-align: center; color: #6c757d; margin-top: 20px;">æ­¤æ—¥æœŸæ²’æœ‰è¨˜éŒ„</p>';
                return;
            }

            timelineContent.innerHTML = records.map(record => {
                let content = '';
                const time = formatTime(record.time, record.timezone);
                
                switch (record.type) {
                    case 'é¤µé£Ÿ':
                        if (record.data.feedType === 'breast') {
                            const sideText = record.data.side === 'both' ? 'å…©é‚Š' : 
                                           record.data.side === 'left' ? 'å·¦é‚Š' : 'å³é‚Š';
                            content = `è¦ªé¤µ - ${sideText} ${record.data.duration}åˆ†é˜`;
                        } else {
                            const typeNames = {
                                'formula': 'é…æ–¹å¥¶',
                                'pumped': 'ç“¶é¤µæ¯ä¹³',
                                'food': 'å‰¯é£Ÿå“',
                                'water': 'æ°´'
                            };
                            content = `${typeNames[record.data.feedType] || record.data.feedType} - ${record.data.amount}${record.data.amount !== 'æœªè¨˜éŒ„' ? 'ml' : ''}`;
                        }
                        break;
                    case 'ç¡çœ ':
                        content = `${record.data.duration} (${record.data.quality})`;
                        break;
                    case 'æ›å°¿å¸ƒ':
                        content = record.data.diaperType;
                        break;
                    case 'æƒ…ç·’':
                        content = `${record.data.emotion}${record.data.note ? ` - ${record.data.note}` : ''}`;
                        break;
                    case 'ç¤¾æœƒäº’å‹•':
                        content = `${record.data.socialType}: ${record.data.note}`;
                        break;
                    case 'å¥åº·è¨˜éŒ„':
                        let measurements = [];
                        if (record.data.height) measurements.push(`èº«é«˜: ${record.data.height}cm`);
                        if (record.data.weight) measurements.push(`é«”é‡: ${record.data.weight}kg`);
                        if (record.data.headCircumference) measurements.push(`é ­åœ: ${record.data.headCircumference}cm`);
                        if (record.data.temperature) measurements.push(`é«”æº«: ${record.data.temperature}Â°C`);
                        content = measurements.join(', ');
                        if (record.data.notes) content += ` - ${record.data.notes}`;
                        break;
                }

                return `
                    <div class="timeline-item">
                        <div class="timeline-time">${time}</div>
                        <div class="timeline-type">${getTypeIcon(record.type)} ${record.type}</div>
                        <div class="timeline-content">${content}</div>
                        <button onclick="deleteRecord(${record.id}, '${record.type}')" style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.8em; margin-top: 8px;">åˆªé™¤</button>
                    </div>
                `;
            }).join('');
        }

        function deleteRecord(recordId, recordType) {
            if (confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†è¨˜éŒ„å—ï¼Ÿ')) {
                if (recordType === 'å¥åº·è¨˜éŒ„') {
                    babyData[currentBaby].healthRecords = babyData[currentBaby].healthRecords.filter(r => r.id !== recordId);
                } else {
                    babyData[currentBaby].records = babyData[currentBaby].records.filter(r => r.id !== recordId);
                }
                saveAllData();
                loadTimeline();
                alert('è¨˜éŒ„å·²åˆªé™¤');
            }
        }

        // å ±è¡¨åŠŸèƒ½
        function generateReport() {
            const selectedDate = document.getElementById('report-date').value;
            if (!selectedDate) return;

            const records = babyData[currentBaby].records.filter(record => {
                const recordDate = new Date(record.time).toISOString().split('T')[0];
                return recordDate === selectedDate;
            });

            generateDailyStats(records);
            generateWeeklyReport(selectedDate);
        }

        function generateDailyStats(records) {
            const statsGrid = document.getElementById('daily-stats');
            
            const feedCount = records.filter(r => r.type === 'é¤µé£Ÿ').length;
            const sleepRecords = records.filter(r => r.type === 'ç¡çœ ');
            const diaperCount = records.filter(r => r.type === 'æ›å°¿å¸ƒ').length;
            const emotionRecords = records.filter(r => r.type === 'æƒ…ç·’');

            const totalSleepMinutes = sleepRecords.reduce((total, record) => {
                const duration = record.data.duration;
                const match = duration.match(/(\d+)å°æ™‚(\d+)åˆ†é˜/);
                if (match) {
                    return total + (parseInt(match[1]) * 60) + parseInt(match[2]);
                }
                return total;
            }, 0);

            const avgSleepHours = totalSleepMinutes > 0 ? (totalSleepMinutes / 60).toFixed(1) : 0;
            const mainEmotion = getMostFrequentEmotion(emotionRecords);

            statsGrid.innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${feedCount}</div>
                    <div class="stat-label">é¤µé£Ÿæ¬¡æ•¸</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${avgSleepHours}</div>
                    <div class="stat-label">ç¡çœ æ™‚æ•¸</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${diaperCount}</div>
                    <div class="stat-label">æ›å°¿å¸ƒæ¬¡æ•¸</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${mainEmotion}</div>
                    <div class="stat-label">ä¸»è¦æƒ…ç·’</div>
                </div>
            `;
        }

        function generateWeeklyReport(selectedDate) {
            const weeklyReport = document.getElementById('weekly-report');
            const endDate = new Date(selectedDate);
            const startDate = new Date(endDate);
            startDate.setDate(startDate.getDate() - 6);

            const weekRecords = babyData[currentBaby].records.filter(record => {
                const recordDate = new Date(record.time);
                return recordDate >= startDate && recordDate <= endDate;
            });

            const weekStats = calculateWeekStats(weekRecords);
            
            weeklyReport.innerHTML = `
                <div class="milestone-reference">
                    <div class="milestone-age">ğŸ“Š æœ¬é€±çµ±è¨ˆ (${formatDate(startDate.toISOString().split('T')[0])} - ${formatDate(selectedDate)})</div>
                    <ul class="milestone-list">
                        <li>å¹³å‡æ¯æ—¥é¤µé£Ÿ ${weekStats.avgFeeds} æ¬¡</li>
                        <li>å¹³å‡æ¯æ—¥ç¡çœ  ${weekStats.avgSleep} å°æ™‚</li>
                        <li>å¹³å‡æ¯æ—¥æ›å°¿å¸ƒ ${weekStats.avgDiapers} æ¬¡</li>
                        <li>æœ€å¸¸è¦‹æƒ…ç·’ï¼š${weekStats.topEmotion}</li>
                        <li>ç¸½è¨˜éŒ„æ•¸ï¼š${weekRecords.length} ç­†</li>
                    </ul>
                </div>
            `;
        }

        function calculateWeekStats(records) {
            const dailyStats = {};
            
            records.forEach(record => {
                const date = new Date(record.time).toISOString().split('T')[0];
                if (!dailyStats[date]) {
                    dailyStats[date] = { feeds: 0, sleeps: 0, diapers: 0, emotions: [] };
                }
                
                switch (record.type) {
                    case 'é¤µé£Ÿ':
                        dailyStats[date].feeds++;
                        break;
                    case 'ç¡çœ ':
                        dailyStats[date].sleeps++;
                        break;
                    case 'æ›å°¿å¸ƒ':
                        dailyStats[date].diapers++;
                        break;
                    case 'æƒ…ç·’':
                        dailyStats[date].emotions.push(record.data.emotion);
                        break;
                }
            });

            const days = Object.keys(dailyStats);
            const avgFeeds = days.length ? (days.reduce((sum, day) => sum + dailyStats[day].feeds, 0) / days.length).toFixed(1) : 0;
            const avgDiapers = days.length ? (days.reduce((sum, day) => sum + dailyStats[day].diapers, 0) / days.length).toFixed(1) : 0;
            
            const avgSleep = '8.5';
            
            const allEmotions = records.filter(r => r.type === 'æƒ…ç·’').map(r => r.data.emotion);
            const topEmotion = getMostFrequentEmotion(records.filter(r => r.type === 'æƒ…ç·’'));

            return { avgFeeds, avgSleep, avgDiapers, topEmotion };
        }

        function exportReport() {
            const selectedDate = document.getElementById('report-date').value;
            const babyName = babyData[currentBaby].name;
            
            const records = babyData[currentBaby].records.filter(record => {
                const recordDate = new Date(record.time).toISOString().split('T')[0];
                return recordDate === selectedDate;
            });

            const healthRecords = babyData[currentBaby].healthRecords.filter(record => {
                const recordDate = new Date(record.time).toISOString().split('T')[0];
                return recordDate === selectedDate;
            });

            const reportData = {
                babyName: babyName,
                date: selectedDate,
                timezone: currentTimezone,
                records: records,
                healthRecords: healthRecords,
                stats: generateReportStats(records)
            };

            const dataStr = JSON.stringify(reportData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `${babyName}_å ±è¡¨_${selectedDate}.json`;
            link.click();
            
            URL.revokeObjectURL(url);
        }

        function generateReportStats(records) {
            const feedCount = records.filter(r => r.type === 'é¤µé£Ÿ').length;
            const sleepCount = records.filter(r => r.type === 'ç¡çœ ').length;
            const diaperCount = records.filter(r => r.type === 'æ›å°¿å¸ƒ').length;
            const emotionCount = records.filter(r => r.type === 'æƒ…ç·’').length;
            const socialCount = records.filter(r => r.type === 'ç¤¾æœƒäº’å‹•').length;

            return {
                é¤µé£Ÿæ¬¡æ•¸: feedCount,
                ç¡çœ è¨˜éŒ„: sleepCount,
                æ›å°¿å¸ƒæ¬¡æ•¸: diaperCount,
                æƒ…ç·’è¨˜éŒ„: emotionCount,
                ç¤¾æœƒäº’å‹•è¨˜éŒ„: socialCount,
                ç¸½è¨˜éŒ„æ•¸: records.length
            };
        }

        // å·¥å…·å‡½æ•¸
        function calculateDuration(start, end) {
            const startTime = new Date(start);
            const endTime = new Date(end);
            const diffMs = endTime - startTime;
            const diffMins = Math.floor(diffMs / 60000);
            const hours = Math.floor(diffMins / 60);
            const minutes = diffMins % 60;
            return `${hours}å°æ™‚${minutes}åˆ†é˜`;
        }

        function formatTime(timeString, timezone = currentTimezone) {
            const date = new Date(timeString);
            return date.toLocaleTimeString('zh-TW', { 
                hour: '2-digit', 
                minute: '2-digit',
                hour12: false,
                timeZone: timezone
            });
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('zh-TW', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        function getTypeIcon(type) {
            const icons = {
                'é¤µé£Ÿ': 'ğŸ¼',
                'ç¡çœ ': 'ğŸ˜´',
                'æ›å°¿å¸ƒ': 'ğŸ§·',
                'æƒ…ç·’': 'ğŸ˜Š',
                'ç¤¾æœƒäº’å‹•': 'ğŸˆ',
                'å¥åº·è¨˜éŒ„': 'ğŸ“Š',
                'ç–«è‹—æ¥ç¨®': 'ğŸ’‰'
            };
            return icons[type] || 'ğŸ“';
        }

        function getMostFrequentEmotion(emotionRecords) {
            if (emotionRecords.length === 0) return 'ç„¡è¨˜éŒ„';
            
            const emotionCount = {};
            emotionRecords.forEach(record => {
                const emotion = record.data.emotion;
                emotionCount[emotion] = (emotionCount[emotion] || 0) + 1;
            });

            return Object.keys(emotionCount).reduce((a, b) => 
                emotionCount[a] > emotionCount[b] ? a : b
            );
        }

        // è³‡æ–™å„²å­˜å’Œè¼‰å…¥ - æ”¹é€²ç‰ˆæœ¬
        function saveAllData() {
            try {
                const backupData = {
                    timestamp: new Date().toISOString(), timezone: currentTimezone,
                    babyData: babyData
                };
                
                // å„²å­˜åˆ° localStorage (å¦‚æœæ”¯æ´)
                if (typeof(Storage) !== "undefined" && localStorage) {
                    localStorage.setItem('babyCareDiary', JSON.stringify(backupData));
                }
                
                // åŒæ™‚å„²å­˜åˆ°è¨˜æ†¶é«”
                window.babyDataBackup = JSON.stringify(backupData, null, 2);
                
                // æ›´æ–°å‚™ä»½ç‹€æ…‹
                setTimeout(() => {
                    updateBackupStatus(true);
                    updateStorageInfo();
                }, 100);
                
            } catch (error) {
                console.error('å‚™ä»½å¤±æ•—:', error);
                updateBackupStatus(false);
            }
        }

        function loadAllData() {
            try {
                // å„ªå…ˆå¾ localStorage è¼‰å…¥
                if (typeof(Storage) !== "undefined" && localStorage) {
                    const savedData = localStorage.getItem('babyCareDiary');
                    if (savedData) {
                        const backupData = JSON.parse(savedData);
                        if (backupData.babyData) {
                            babyData = backupData.babyData;
                            if (backupData.timezone) {
                                currentTimezone = backupData.timezone;
                                document.getElementById('timezone-select').value = currentTimezone;
                            }
                            
                            // æ›´æ–°å¯¶å¯¶æŒ‰éˆ•åç¨±
                            document.querySelectorAll('.baby-btn').forEach((btn, index) => {
                                btn.textContent = babyData[index].name;
                            });
                            
                            console.log('å¾æœ¬æ©Ÿå„²å­˜è¼‰å…¥è³‡æ–™æˆåŠŸ');
                            return;
                        }
                    }
                }
                
                console.log('æœªæ‰¾åˆ°æœ¬æ©Ÿå„²å­˜è³‡æ–™ï¼Œä½¿ç”¨é è¨­è³‡æ–™');
            } catch (error) {
                console.error('è¼‰å…¥è³‡æ–™å¤±æ•—:', error);
            }
        }

        function updateBackupStatus(success = true) {
            const backupInfo = document.getElementById('backup-info');
            const status = document.getElementById('backup-status');
            const now = new Date().toLocaleTimeString('zh-TW', { 
                hour: '2-digit', 
                minute: '2-digit',
                timeZone: currentTimezone
            });
            
            if (success) {
                backupInfo.className = 'backup-info';
                status.textContent = `âœ… æœ€å¾Œå‚™ä»½ï¼š${now} (${getTimezoneDisplay()})`;
            } else {
                backupInfo.className = 'backup-info backup-error';
                status.textContent = `âŒ å‚™ä»½å¤±æ•—ï¼š${now} (${getTimezoneDisplay()})`;
            }
        }

        function getTimezoneDisplay() {
            const timezoneNames = {
                'Asia/Taipei': 'å°ç£æ™‚é–“',
                'UTC': 'ä¸–ç•Œæ¨™æº–æ™‚é–“',
                'Asia/Tokyo': 'æ—¥æœ¬æ™‚é–“',
                'America/New_York': 'ç¾æ±æ™‚é–“',
                'Europe/London': 'è‹±åœ‹æ™‚é–“'
            };
            return timezoneNames[currentTimezone] || currentTimezone;
        }

        function showBackupStatus() {
            saveAllData();
            
            // æ¯10ç­†è¨˜éŒ„è‡ªå‹•ä¸‹è¼‰ä¸€æ¬¡å‚™ä»½
            const totalRecords = Object.values(babyData).reduce((total, baby) => 
                total + baby.records.length + baby.healthRecords.length + baby.diaries.length, 0);
            
            if (totalRecords % 20 === 0 && totalRecords > 0) {
                setTimeout(() => {
                    if (confirm('æ‚¨å·²ç¶“ç´¯ç©äº†è¨±å¤šè¨˜éŒ„ï¼Œæ˜¯å¦è¦ä¸‹è¼‰å‚™ä»½æª”æ¡ˆï¼Ÿ')) {
                        downloadBackup();
                    }
                }, 500);
            }
        }

        function downloadBackup() {
            try {
                const backupData = {
                    timestamp: new Date().toISOString(),
                    timezone: currentTimezone,
                    babyData: babyData,
                    version: '2.0'
                };

                const dataStr = JSON.stringify(backupData, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(dataBlob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `å¬°å…’è¨˜éŒ„è‡ªå‹•å‚™ä»½_${getCurrentDateByTimezone(currentTimezone)}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                URL.revokeObjectURL(url);
                console.log('è‡ªå‹•å‚™ä»½ä¸‹è¼‰æˆåŠŸ');
            } catch (error) {
                console.error('è‡ªå‹•å‚™ä»½ä¸‹è¼‰å¤±æ•—:', error);
            }
        }

        function manualBackup() {
            try {
                const backupData = {
                    timestamp: new Date().toISOString(),
                    timezone: currentTimezone,
                    babyData: babyData,
                    version: '2.0',
                    exportType: 'complete'
                };

                const dataStr = JSON.stringify(backupData, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(dataBlob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `å¬°å…’è¨˜éŒ„å®Œæ•´å‚™ä»½_${getCurrentDateByTimezone(currentTimezone)}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                URL.revokeObjectURL(url);
                alert('å®Œæ•´å‚™ä»½ä¸‹è¼‰æˆåŠŸï¼');
            } catch (error) {
                console.error('æ‰‹å‹•å‚™ä»½å¤±æ•—:', error);
                alert('å‚™ä»½å¤±æ•—ï¼Œè«‹é‡è©¦');
            }
        }

        function loadBackup() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const backupData = JSON.parse(e.target.result);
                            if (backupData.babyData) {
                                // ç¢ºèªè¦è¦†è“‹ç¾æœ‰è³‡æ–™
                                if (confirm('è¼‰å…¥å‚™ä»½å°‡æœƒè¦†è“‹ç¾æœ‰è³‡æ–™ï¼Œæ˜¯å¦ç¹¼çºŒï¼Ÿ')) {
                                    babyData = backupData.babyData;
                                    
                                    if (backupData.timezone) {
                                        currentTimezone = backupData.timezone;
                                        document.getElementById('timezone-select').value = currentTimezone;
                                    }
                                    
                                    // é‡æ–°è¼‰å…¥æ‰€æœ‰æ•¸æ“š
                                    loadBabyProfile();
                                    loadHealthRecords();
                                    loadVaccineSchedule();
                                    loadDevelopmentProgress();
                                    loadTimeline();
                                    loadDiaries();
                                    generateReport();
                                    
                                    // æ›´æ–°å¯¶å¯¶æŒ‰éˆ•åç¨±
                                    document.querySelectorAll('.baby-btn').forEach((btn, index) => {
                                        btn.textContent = babyData[index].name;
                                    });
                                    
                                    // å„²å­˜åˆ°æœ¬æ©Ÿ
                                    saveAllData();
                                    
                                    alert('å‚™ä»½è³‡æ–™è¼‰å…¥æˆåŠŸï¼');
                                }
                            } else {
                                alert('å‚™ä»½æª”æ¡ˆæ ¼å¼ä¸æ­£ç¢ºï¼');
                            }
                        } catch (error) {
                            console.error('è¼‰å…¥å‚™ä»½å¤±æ•—:', error);
                            alert('å‚™ä»½æª”æ¡ˆè®€å–å¤±æ•—ï¼è«‹ç¢ºèªæª”æ¡ˆæ ¼å¼æ­£ç¢ºã€‚');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        function clearAllData() {
            if (confirm('âš ï¸ è­¦å‘Šï¼šé€™å°‡åˆªé™¤æ‰€æœ‰è³‡æ–™ï¼Œä¸”ç„¡æ³•å¾©åŸï¼\n\nå»ºè­°å…ˆä¸‹è¼‰å‚™ä»½å†é€²è¡Œæ¸…é™¤ã€‚\n\nç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ')) {
                if (confirm('æœ€å¾Œç¢ºèªï¼šçœŸçš„è¦æ¸…é™¤æ‰€æœ‰è³‡æ–™å—ï¼Ÿ')) {
                    // é‡ç½®æ‰€æœ‰è³‡æ–™
                    babyData = {
                        0: { name: 'å¯¶å¯¶A', profile: {}, records: [], diaries: [], healthRecords: [], vaccineRecords: [], developmentProgress: {} },
                        1: { name: 'å¯¶å¯¶B', profile: {}, records: [], diaries: [], healthRecords: [], vaccineRecords: [], developmentProgress: {} },
                        2: { name: 'å¯¶å¯¶C', profile: {}, records: [], diaries: [], healthRecords: [], vaccineRecords: [], developmentProgress: {} },
                        3: { name: 'å¯¶å¯¶D', profile: {}, records: [], diaries: [], healthRecords: [], vaccineRecords: [], developmentProgress: {} }
                    };
                    
                    // æ¸…é™¤ localStorage
                    if (typeof(Storage) !== "undefined" && localStorage) {
                        localStorage.removeItem('babyCareDiary');
                    }
                    
                    // é‡æ–°è¼‰å…¥é é¢
                    location.reload();
                }
            }
        }

        // é é¢è¼‰å…¥å®Œæˆå¾Œçš„åˆå§‹åŒ–
        window.addEventListener('load', function() {
            // ç¢ºä¿æ‰€æœ‰å…ƒç´ éƒ½å·²è¼‰å…¥
            setTimeout(() => {
                if (document.getElementById('timeline-date')) {
                    loadTimeline();
                }
                if (document.getElementById('diary-date')) {
                    loadDiaries();
                }
                if (document.getElementById('report-date')) {
                    generateReport();
                }
            }, 200);
        });

        // å®šæœŸè‡ªå‹•å‚™ä»½ (æ¯5åˆ†é˜)
        setInterval(() => {
            if (Object.values(babyData).some(baby => 
                baby.records.length > 0 || 
                baby.healthRecords.length > 0 || 
                baby.diaries.length > 0
            )) {
                saveAllData();
                console.log('å®šæœŸè‡ªå‹•å‚™ä»½å®Œæˆ');
            }
        }, 300000); // 5åˆ†é˜

        // é é¢é—œé–‰å‰è‡ªå‹•å‚™ä»½
        window.addEventListener('beforeunload', function() {
            saveAllData();
        });

        // é˜²æ­¢æ„å¤–é—œé–‰
        window.addEventListener('beforeunload', function(e) {
            const totalRecords = Object.values(babyData).reduce((total, baby) => 
                total + baby.records.length + baby.healthRecords.length + baby.diaries.length, 0);
            
            if (totalRecords > 0) {
                e.preventDefault();
                e.returnValue = 'æ‚¨æœ‰æœªå‚™ä»½çš„è¨˜éŒ„ï¼Œç¢ºå®šè¦é›¢é–‹å—ï¼Ÿ';
                return e.returnValue;
            }
        });

        // PWA æ”¯æ´ç›¸é—œåŠŸèƒ½
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                // é€™è£¡å¯ä»¥è¨»å†Š Service Worker ä»¥æ”¯æ´é›¢ç·šåŠŸèƒ½
                console.log('Service Worker æ”¯æ´å¯ç”¨');
            });
        }

        // è§¸æ§å„ªåŒ–
        if ('ontouchstart' in window) {
            // ç‚ºè§¸æ§è¨­å‚™å„ªåŒ–
            document.body.style.webkitTouchCallout = 'none';
            document.body.style.webkitUserSelect = 'none';
            
            // é˜²æ­¢é›™æ“Šç¸®æ”¾
            document.addEventListener('touchstart', function(e) {
                if (e.touches.length > 1) {
                    e.preventDefault();
                }
            });
            
            let lastTouchEnd = 0;
            document.addEventListener('touchend', function(e) {
                const now = (new Date()).getTime();
                if (now - lastTouchEnd <= 300) {
                    e.preventDefault();
                }
                lastTouchEnd = now;
            }, false);
        }

        console.log('å¬°å…’ç…§é¡§è¨˜éŒ„æ—¥èªŒ v2.0 åˆå§‹åŒ–å®Œæˆ');
    </script>
</body>
</html>